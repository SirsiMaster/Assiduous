<!DOCTYPE html>
<html lang="en" data-auth-protect="agent">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Assiduous Agent Portal</title>
    
    <!-- Assiduous Design System -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="../assiduous.css">
    <link rel="stylesheet" href="../components/admin-layout.css">

    <!-- Canonical modular Firebase bootstrap for portal pages -->
    <script type="module" src="../assets/js/firebase-init.js"></script>
    
    <style>
/* Minimal dashboard-specific styles only */
        .dashboard-content {
            padding: var(--space-xl);
            overflow-y: auto;
            background: var(--gray-50);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-lg);
            margin-bottom: var(--space-2xl);
        }

        .stat-card {
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: var(--space-lg);
            transition: all 0.2s;
        }

        .stat-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: var(--space-md);
        }

        .stat-icon.blue { background: rgba(96, 163, 217, 0.1); color: var(--sky); }
        .stat-icon.green { background: rgba(5, 150, 105, 0.1); color: var(--success); }
        .stat-icon.yellow { background: rgba(255, 217, 64, 0.1); color: var(--warning); }
        .stat-icon.red { background: rgba(220, 38, 38, 0.1); color: var(--danger); }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: var(--space-xs);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.025em;
            margin-bottom: var(--space-sm);
        }

        .stat-change {
            font-size: 12px;
            font-weight: 600;
        }

        .stat-change.up { color: var(--success); }
        .stat-change.down { color: var(--danger); }

        /* Content Grid */
        .content-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: var(--space-xl);
        }

        /* Tables */
        .data-table {
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            overflow: hidden;
        }

        .table-header {
            padding: var(--space-md) var(--space-lg);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--dark);
        }

        .table-action {
            padding: var(--space-xs) var(--space-sm);
            background: var(--sky);
            color: var(--white);
            border: none;
            border-radius: var(--radius);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }

        .table-action:hover {
            background: #4A8BC2;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            padding: var(--space-sm) var(--space-lg);
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.025em;
            background: var(--gray-50);
        }

        td {
            padding: var(--space-md) var(--space-lg);
            border-top: 1px solid var(--border);
            font-size: 14px;
        }

        .status {
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--radius);
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .status.active { background: rgba(5, 150, 105, 0.1); color: var(--success); }
        .status.pending { background: rgba(255, 217, 64, 0.1); color: var(--warning); }
        .status.inactive { background: rgba(107, 114, 128, 0.1); color: var(--text-secondary); }

        /* Activity Feed */
        .activity-feed {
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
        }

        .activity-item {
            padding: var(--space-md) var(--space-lg);
            display: flex;
            gap: var(--space-md);
            border-bottom: 1px solid var(--border);
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--gray-50);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            color: var(--text-secondary);
        }

        .activity-content {
            flex: 1;
        }

        .activity-text {
            font-size: 14px;
            color: var(--dark);
            margin-bottom: var(--space-xs);
        }

        .activity-time {
            font-size: 12px;
            color: var(--text-secondary);
        }
    </style>
</head>
<body class="admin-wrapper" data-active="dashboard">
    <!-- UCS Sidebar Component -->
    <aside class="sidebar" data-component="sidebar"></aside>

    <!-- Main Content Area -->
    <div class="main-content">
        <!-- UCS Header Component -->
        <header data-component="header"></header>

        <!-- Dashboard Content -->
        <div class="dashboard-content">
<!-- Stats Grid -->
                <div class="stats-grid" id="statsGrid">
                    <div class="stat-card sirsi-card sirsi-sm-sm-card--elevated">
                        <div class="stat-icon blue">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                                <polyline points="9 22 9 12 15 12 15 22"></polyline>
                            </svg>
                        </div>
                        <div class="stat-value" id="activeListingsCount">24</div>
                        <div class="stat-label">My Active Listings</div>
                        <div class="stat-change up">+3 this month</div>
                    </div>

                    <div class="stat-card sirsi-card sirsi-sm-sm-card--elevated">
                        <div class="stat-icon green">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="1" x2="12" y2="23"></line>
                                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                            </svg>
                        </div>
                        <div class="stat-value" id="commissionYTD">$45.2K</div>
                        <div class="stat-label">Commission YTD</div>
                        <div class="stat-change up">+15% from last year</div>
                    </div>

                    <div class="stat-card sirsi-card sirsi-sm-sm-card--elevated">
                        <div class="stat-icon yellow">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                <circle cx="12" cy="7" r="4"></circle>
                            </svg>
                        </div>
                        <div class="stat-value" id="activeClientsCount">18</div>
                        <div class="stat-label">Active Clients</div>
                        <div class="stat-change up">+2 this week</div>
                    </div>

                    <div class="stat-card sirsi-card sirsi-sm-sm-card--elevated">
                        <div class="stat-icon red">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="20" x2="12" y2="10"></line>
                                <line x1="18" y1="20" x2="18" y2="4"></line>
                                <line x1="6" y1="20" x2="6" y2="16"></line>
                            </svg>
                        </div>
                    <div class="stat-value" id="newLeadsCount">7</div>
                    <div class="stat-label">New Leads</div>
                    <div class="stat-change up">+2 today</div>
                </div>
            </div>
            
            <!-- Recent Listings Table -->
            <div style="background: var(--white); border: 1px solid var(--border); border-radius: var(--radius-md); margin-top: var(--space-xl);">
                <div style="padding: var(--space-md) var(--space-lg); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="font-size: 16px; font-weight: 600; color: var(--dark);">Recent Listings</h2>
                    <a href="listings.html" style="color: var(--sky); text-decoration: none; font-size: 14px;">View All â†’</a>
                </div>
                <div class="data-table" style="border: none;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead style="background: var(--gray-50);">
                            <tr>
                                <th style="padding: var(--space-md); text-align: left; font-size: 12px; font-weight: 600; color: var(--text-secondary);">Property</th>
                                <th style="padding: var(--space-md); text-align: left; font-size: 12px; font-weight: 600; color: var(--text-secondary);">Type</th>
                                <th style="padding: var(--space-md); text-align: left; font-size: 12px; font-weight: 600; color: var(--text-secondary);">Price</th>
                                <th style="padding: var(--space-md); text-align: left; font-size: 12px; font-weight: 600; color: var(--text-secondary);">Status</th>
                                <th style="padding: var(--space-md); text-align: left; font-size: 12px; font-weight: 600; color: var(--text-secondary);">Views</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="5" style="text-align: center; padding: var(--space-xl); color: var(--text-secondary);">Loading listings...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- UCS Core Scripts -->
    <script src="../components/ucs-core.js"></script>
    <script src="../components/component-registry.js"></script>
    <script src="../components/auth-guard.js"></script>
    <script src="../components/universal-header.js"></script>
    <script>
        // Canonical agent dashboard bootstrap using modular Firebase services
        (function() {
            function formatCurrency(amount) {
                if (!isFinite(amount)) return '$0';
                if (amount >= 1000) {
                    return `$${(amount / 1000).toFixed(1)}K`;
                }
                return `$${Math.round(amount).toLocaleString()}`;
            }

            async function loadAgentDashboard(user) {
                if (!window.DatabaseService) {
                    console.warn('[Agent Dashboard] DatabaseService not available; skipping metrics load');
                    return;
                }

                var activeListingsEl = document.getElementById('activeListingsCount');
                var commissionYTDEl = document.getElementById('commissionYTD');
                var activeClientsEl = document.getElementById('activeClientsCount');
                var newLeadsEl = document.getElementById('newLeadsCount');

                try {
                    var agentEmail = user.email || '';
                    var agentId = user.uid;

                    // Load core stats in parallel
                    var [properties, leads, transactions] = await Promise.all([
                        window.DatabaseService.getDocuments('properties', [
                            { field: 'agent.email', operator: '==', value: agentEmail }
                        ]),
                        window.DatabaseService.getDocuments('leads', [
                            { field: 'assignedAgent', operator: '==', value: agentEmail }
                        ]),
                        window.DatabaseService.getDocuments('transactions', [
                            { field: 'agentId', operator: '==', value: agentId },
                            { field: 'status', operator: '==', value: 'closed' }
                        ])
                    ]);

                    var activeListings = properties.filter(function(p) {
                        return (p.status || '').toLowerCase() === 'available';
                    }).length;

                    var newLeads = leads.filter(function(l) {
                        return (l.status || '').toLowerCase() === 'new';
                    }).length;

                    var uniqueClients = new Set();
                    leads.forEach(function(l) {
                        var email = l.user && l.user.email;
                        if (email) uniqueClients.add(email);
                    });
                    var activeClients = uniqueClients.size;

                    var totalCommission = 0;
                    transactions.forEach(function(tx) {
                        var amount = 0;
                        if (tx.financial && tx.financial.commission) {
                            amount = Number(tx.financial.commission);
                        } else if (tx.agreedPrice && tx.commissionRate) {
                            amount = Number(tx.agreedPrice) * Number(tx.commissionRate);
                        }
                        if (isFinite(amount)) totalCommission += amount;
                    });

                    if (activeListingsEl) activeListingsEl.textContent = activeListings;
                    if (commissionYTDEl) commissionYTDEl.textContent = formatCurrency(totalCommission);
                    if (activeClientsEl) activeClientsEl.textContent = activeClients;
                    if (newLeadsEl) newLeadsEl.textContent = newLeads;

                    await loadRecentListings(agentEmail, properties);

                    console.log('[Agent Dashboard] Metrics loaded', {
                        activeListings,
                        totalCommission,
                        activeClients,
                        newLeads
                    });
                } catch (error) {
                    console.error('[Agent Dashboard] Failed to load metrics:', error);
                    showError('Failed to load dashboard data. Please refresh the page.');
                }
            }

            async function loadRecentListings(agentEmail, preloadedProperties) {
                var tbody = document.querySelector('.data-table tbody');
                if (!tbody) return;

                var properties = Array.isArray(preloadedProperties) ? preloadedProperties.slice() : [];

                // Sort by createdAt if present
                properties.sort(function(a, b) {
                    var aTs = a.createdAt && a.createdAt.toMillis ? a.createdAt.toMillis() : 0;
                    var bTs = b.createdAt && b.createdAt.toMillis ? b.createdAt.toMillis() : 0;
                    return bTs - aTs;
                });

                var recent = properties.filter(function(p) {
                    return p.agent && p.agent.email === agentEmail;
                }).slice(0, 5);

                tbody.innerHTML = '';

                if (!recent.length) {
                    var row = document.createElement('tr');
                    row.innerHTML = '<td colspan="5" style="text-align:center;padding:var(--space-xl);color:var(--text-secondary);">No listings found. Properties will appear here when assigned to you.</td>';
                    tbody.appendChild(row);
                    return;
                }

                recent.forEach(function(p) {
                    var row = document.createElement('tr');
                    var status = (p.status || 'Unknown').toLowerCase();
                    var statusClass = status === 'available' ? 'success' : (status === 'pending' ? 'warning' : 'inactive');

                    row.innerHTML = '
                        <td>
                            <div style="font-weight:600;">' + (p.address && p.address.street || 'N/A') + '</div>
                            <div style="font-size:12px;color:var(--text-secondary);">' +
                                (p.address && p.address.city || 'Philadelphia') + ', ' +
                                (p.address && p.address.state || 'PA') + ' ' +
                                (p.address && p.address.zip || '') +
                            '</div>
                        </td>
                        <td>' + (p.details && p.details.type || 'N/A') + '</td>
                        <td>$' + ((p.price && p.price.list) || 0).toLocaleString() + '</td>
                        <td><span class="sirsi-badge sirsi-sm-sm-badge--' + statusClass + '">' + (p.status || 'Unknown') + '</span></td>
                        <td>' + (p.metrics && p.metrics.views || 0) + '</td>
                    ';

                    tbody.appendChild(row);
                });
            }

            function showError(message) {
                var errorDiv = document.createElement('div');
                errorDiv.style.cssText = '
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: var(--danger);
                    color: white;
                    padding: var(--space-md) var(--space-lg);
                    border-radius: var(--radius-md);
                    box-shadow: var(--shadow-lg);
                    z-index: 9999;
                ';
                errorDiv.textContent = message;
                document.body.appendChild(errorDiv);

                setTimeout(function() {
                    errorDiv.remove();
                }, 5000);
            }

            function init() {
                if (!window.authGuard || typeof window.authGuard.protect !== 'function') {
                    console.error('[Agent Dashboard] auth-guard not available');
                    return;
                }

                window.authGuard.protect('agent', {
                    requireEmailVerification: true,
                    onSuccess: function(user) {
                        // Header personalization can be handled by universal-header.js
                        loadAgentDashboard(user);
                    }
                });
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
            } else {
                init();
            }
        })();
    </script>
</body>
</html>
