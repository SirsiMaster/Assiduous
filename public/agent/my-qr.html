<!DOCTYPE html>
<html lang="en" data-auth-protect="agent">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>My QR Code - Agent - Assiduous</title>

    <link rel="stylesheet" href="../assiduous.css">
    <link rel="stylesheet" href="../components/admin-layout.css">

    <script type="module">
        import Firebase, { AuthService } from '../assets/js/firebase-init.js';
        window.Firebase = Firebase;
        window.AuthService = AuthService;
    </script>
</head>
<body class="admin-wrapper" data-active="my-qr">
    <aside class="sidebar" data-component="sidebar"></aside>
    <div class="main-content">
        <header data-component="header"></header>
        <div class="dashboard-content">
            <h1>My Profile QR Code</h1>
            <p>Share your agent profile/settings page with a scannable QR code.</p>
            <div id="qrDisplay" class="qr-display-section">
                <div class="qr-loading">Loading your QR code...</div>
            </div>
            <p>Profile link: <span id="profileUrl" class="profile-url"></span></p>
            <div class="qr-actions-grid">
                <button onclick="downloadQR()">Download QR</button>
                <button onclick="copyProfileLink()">Copy link</button>
                <button onclick="shareQR()">Share</button>
                <button onclick="regenerateQR()">Regenerate</button>
            </div>
        </div>
    </div>

    <script src="../components/ucs-core.js"></script>
    <script src="../components/component-registry.js"></script>
    <script src="../components/auth-guard.js"></script>
    <script>
        let currentUser = null;
        let currentQRData = null;
        let auth;
        let functionsService;

        window.addEventListener('firebase-ready', () => {
            const firebase = window.Firebase || {};
            auth = firebase.auth || window.firebaseAuth;
            functionsService = firebase.CloudFunctionsService || null;

            auth.onAuthStateChanged(async (user) => {
                if (!user) {
                    window.location.href = '../index.html#login';
                    return;
                }
                currentUser = user;
                await loadUserQR();
            });
        });

        async function loadUserQR() {
            if (!functionsService) return;
            const qrDisplay = document.getElementById('qrDisplay');
            try {
                const response = await functionsService.generateUserQR({regenerate: false});
                if (!response || !response.success) throw new Error(response?.error || 'Failed to load QR');
                currentQRData = response.data;
                document.getElementById('profileUrl').textContent = currentQRData.profileUrl;
                qrDisplay.innerHTML = `<img src="${currentQRData.qrCodeUrl}" alt="Profile QR Code" />`;
            } catch (error) {
                qrDisplay.innerHTML = `<div class="qr-loading" style="color:red;">Error loading QR: ${error.message}</div>`;
            }
        }

        function downloadQR() {
            if (!currentQRData) return;
            const link = document.createElement('a');
            link.href = currentQRData.qrCodeUrl;
            link.download = `${currentUser.displayName || 'My'}-Profile-QR.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function copyProfileLink() {
            if (!currentQRData) return;
            navigator.clipboard.writeText(currentQRData.profileUrl).catch(() => {});
        }

        function shareQR() {
            if (!currentQRData) return;
            if (navigator.share) {
                navigator.share({
                    title: 'My Assiduous Agent Profile',
                    text: 'Connect with me on Assiduous',
                    url: currentQRData.profileUrl
                }).catch(() => {});
            } else {
                copyProfileLink();
            }
        }

        async function regenerateQR() {
            if (!functionsService) return;
            const qrDisplay = document.getElementById('qrDisplay');
            qrDisplay.innerHTML = '<div class="qr-loading">Regenerating your QR code...</div>';
            try {
                const response = await functionsService.generateUserQR({regenerate: true});
                if (!response || !response.success) throw new Error(response?.error || 'Failed to regenerate QR');
                currentQRData = response.data;
                document.getElementById('profileUrl').textContent = currentQRData.profileUrl;
                qrDisplay.innerHTML = `<img src="${currentQRData.qrCodeUrl}" alt="Profile QR Code" />`;
            } catch (error) {
                qrDisplay.innerHTML = `<div class="qr-loading" style="color:red;">Error regenerating QR: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>