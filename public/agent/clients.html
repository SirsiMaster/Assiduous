<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Clients - Assiduous Agent Portal</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fontsource/geist-sans@5.0.6/latin.css" rel="stylesheet">
    <link rel="stylesheet" href="../assiduous.css">
    <link rel="stylesheet" href="../components/admin-layout.css">
    <style>
        .dashboard-content { padding: var(--space-xl); background: var(--gray-50); }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-xl); }
        
        /* Button overrides - force styling */
        button.add-btn,
        button.add-btn:hover,
        button.add-btn:focus,
        button.add-btn:active {
            padding: 12px 24px !important;
            background: #60A3D9 !important;
            color: #ffffff !important;
            border: none !important;
            border-radius: 8px !important;
            font-weight: 600 !important;
            cursor: pointer !important;
            transition: all 0.2s !important;
            opacity: 1 !important;
            visibility: visible !important;
            display: inline-block !important;
        }
        button.add-btn:hover {
            background: #4a8cc7 !important;
            transform: translateY(-1px) !important;
        }
        
        button.btn-save,
        button.btn-save:hover,
        button.btn-save:focus,
        button.btn-save:active {
            padding: 10px 24px !important;
            background: #60A3D9 !important;
            color: #ffffff !important;
            border: none !important;
            border-radius: 8px !important;
            font-weight: 600 !important;
            cursor: pointer !important;
            opacity: 1 !important;
            visibility: visible !important;
            display: inline-block !important;
        }
        button.btn-save:hover {
            background: #4a8cc7 !important;
        }
        
        button.btn-cancel,
        button.btn-cancel:hover,
        button.btn-cancel:focus,
        button.btn-cancel:active {
            padding: 10px 24px !important;
            background: #ffffff !important;
            color: #1f2937 !important;
            border: 1px solid #d1d5db !important;
            border-radius: 8px !important;
            cursor: pointer !important;
            opacity: 1 !important;
            visibility: visible !important;
            display: inline-block !important;
        }
        button.btn-cancel:hover {
            background: #f9fafb !important;
        }
        
        .data-table { background: var(--white); border: 1px solid var(--border); border-radius: var(--radius-md); overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        th { padding: var(--space-md); text-align: left; font-size: 12px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; background: var(--gray-50); border-bottom: 1px solid var(--border); }
        td { padding: var(--space-md); font-size: 14px; border-bottom: 1px solid var(--gray-100); }
        tr:hover { background: var(--gray-50); }
        .status-badge { padding: 4px 12px; border-radius: var(--radius); font-size: 12px; font-weight: 600; }
        .status-active { background: rgba(5, 150, 105, 0.1); color: var(--success); }
        .status-inactive { background: rgba(107, 114, 128, 0.1); color: var(--text-secondary); }
        
        button.action-btn,
        button.action-btn:hover {
            padding: 6px 12px !important;
            margin-right: 8px !important;
            border: 1px solid var(--border) !important;
            background: var(--white) !important;
            border-radius: var(--radius) !important;
            cursor: pointer !important;
            font-size: 12px !important;
            transition: all 0.2s !important;
            opacity: 1 !important;
            visibility: visible !important;
        }
        button.action-btn:hover { background: var(--gray-50) !important; }
        button.action-btn.delete { color: var(--danger) !important; border-color: var(--danger) !important; }
        button.action-btn.delete:hover { background: var(--danger) !important; color: var(--white) !important; }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center; }
        .modal.show { display: flex !important; }
        .modal-content { background: var(--white); border-radius: var(--radius-md); width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: var(--space-lg); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-size: 20px; font-weight: 600; }
        .modal-close { background: none !important; border: none !important; font-size: 24px; cursor: pointer; color: var(--text-secondary); }
        .modal-body { padding: var(--space-lg); }
        .form-group { margin-bottom: var(--space-md); }
        .form-label { display: block; font-size: 14px; font-weight: 600; margin-bottom: var(--space-xs); color: var(--dark); }
        .form-input, .form-select, .form-textarea { width: 100%; padding: var(--space-sm) var(--space-md); border: 1px solid var(--border); border-radius: var(--radius); font-size: 14px; }
        .form-textarea { resize: vertical; min-height: 80px; }
        .modal-footer { padding: var(--space-lg); border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: var(--space-sm); }
        .empty-state { text-align: center; padding: var(--space-3xl); color: var(--text-secondary); }
    </style>
</head>
<body class="admin-wrapper" data-active="clients">
    <aside class="sidebar" data-component="sidebar"></aside>
    <div class="main-content">
        <header data-component="header"></header>
        <div class="dashboard-content">
            <div class="page-header">
                <div>
                    <h1 style="font-size: 32px; font-weight: 700; margin-bottom: 8px;">My Clients</h1>
                    <p style="color: var(--text-secondary);">Manage your client relationships</p>
                </div>
                <button class="add-btn" onclick="openAddModal()">+ Add Client</button>
            </div>

            <div class="data-table">
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Status</th>
                            <th>Budget</th>
                            <th>Added</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="clientsTableBody">
                        <tr><td colspan="7" class="empty-state">Loading clients...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Add/Edit Client Modal -->
    <div id="clientModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Add Client</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="clientForm">
                    <input type="hidden" id="clientId">
                    <div class="form-group">
                        <label class="form-label">First Name *</label>
                        <input type="text" class="form-input" id="firstName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Last Name *</label>
                        <input type="text" class="form-input" id="lastName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email *</label>
                        <input type="email" class="form-input" id="email" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone</label>
                        <input type="tel" class="form-input" id="phone" placeholder="(555) 123-4567">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="status">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Budget</label>
                        <input type="text" class="form-input" id="budget" placeholder="$250,000">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Property Preferences</label>
                        <input type="text" class="form-input" id="preferences" placeholder="3 bed, 2 bath, modern">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea class="form-textarea" id="notes" placeholder="Additional notes about the client..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeModal()">Cancel</button>
                <button class="btn-save" onclick="saveClient()">Save Client</button>
            </div>
        </div>
    </div>

    <script src="../components/ucs-core.js"></script>
    <script src="../components/component-registry.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="../firebase-config.js"></script>
    <script>
        let currentUser = null;
        let clients = [];
        let authReady = false;

        // Wait for Firebase to be ready before setting up auth listener
        console.log('Setting up auth listener...');
        
        // Use a function to set up auth once Firebase is ready
        function initAuth() {
            try {
                if (!window.firebase || !firebase.auth) {
                    console.log('Firebase not ready, waiting...');
                    setTimeout(initAuth, 100);
                    return;
                }
                
                console.log('Firebase ready, setting up auth listener');
                firebase.auth().onAuthStateChanged(user => {
                    console.log('Auth state changed. User:', user ? user.email : 'null');
                    if (user) {
                        currentUser = user;
                        authReady = true;
                        console.log('Auth ready set to true');
                        loadClients();
                    } else {
                        console.log('No user, redirecting to login...');
                        window.location.href = '/#login';
                    }
                });
            } catch (error) {
                console.log('Firebase not ready (error), retrying...', error.message);
                setTimeout(initAuth, 100);
            }
        }
        
        // Start init process
        initAuth();

        // Load clients from Firestore
        async function loadClients() {
            try {
                const db = firebase.firestore();
                const snapshot = await db.collection('clients')
                    .where('agentId', '==', currentUser.uid)
                    .get();

                clients = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Sort in memory by creation date (newest first)
                clients.sort((a, b) => {
                    if (!a.createdAt || !b.createdAt) return 0;
                    return b.createdAt.toMillis() - a.createdAt.toMillis();
                });
                renderClients();
            } catch (error) {
                console.error('Error loading clients:', error);
                document.getElementById('clientsTableBody').innerHTML = 
                    '<tr><td colspan="7" class="empty-state">Error loading clients</td></tr>';
            }
        }

        function renderClients() {
            const tbody = document.getElementById('clientsTableBody');
            if (clients.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No clients yet. Click "Add Client" to get started.</td></tr>';
                return;
            }

            tbody.innerHTML = clients.map(client => `
                <tr>
                    <td><strong>${client.firstName} ${client.lastName}</strong></td>
                    <td>${client.email}</td>
                    <td>${client.phone || '-'}</td>
                    <td><span class="status-badge status-${client.status}">${client.status}</span></td>
                    <td>${client.budget || '-'}</td>
                    <td>${formatDate(client.createdAt)}</td>
                    <td>
                        <button class="action-btn" onclick="editClient('${client.id}')">Edit</button>
                        <button class="action-btn delete" onclick="deleteClient('${client.id}')">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function openAddModal() {
            document.getElementById('modalTitle').textContent = 'Add Client';
            document.getElementById('clientForm').reset();
            document.getElementById('clientId').value = '';
            document.getElementById('clientModal').classList.add('show');
        }

        function editClient(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) return;

            document.getElementById('modalTitle').textContent = 'Edit Client';
            document.getElementById('clientId').value = client.id;
            document.getElementById('firstName').value = client.firstName;
            document.getElementById('lastName').value = client.lastName;
            document.getElementById('email').value = client.email;
            document.getElementById('phone').value = client.phone || '';
            document.getElementById('status').value = client.status;
            document.getElementById('budget').value = client.budget || '';
            document.getElementById('preferences').value = client.preferences || '';
            document.getElementById('notes').value = client.notes || '';
            document.getElementById('clientModal').classList.add('show');
        }

        async function saveClient() {
            console.log('Save client clicked. Auth ready:', authReady);
            
            // Wait for auth if not ready yet (usually already done)
            if (!authReady) {
                console.log('Waiting for auth...');
                await new Promise((resolve, reject) => {
                    let attempts = 0;
                    const checkAuth = setInterval(() => {
                        attempts++;
                        if (authReady) {
                            clearInterval(checkAuth);
                            console.log('Auth ready after', attempts * 50, 'ms');
                            resolve();
                        }
                        if (attempts > 60) { // 3 second timeout
                            clearInterval(checkAuth);
                            reject(new Error('Auth timeout'));
                        }
                    }, 50);
                });
            }

            const clientId = document.getElementById('clientId').value;
            const clientData = {
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                status: document.getElementById('status').value,
                budget: document.getElementById('budget').value,
                preferences: document.getElementById('preferences').value,
                notes: document.getElementById('notes').value,
                agentId: currentUser.uid,
                agentEmail: currentUser.email,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                const db = firebase.firestore();
                if (clientId) {
                    // Update existing client
                    await db.collection('clients').doc(clientId).update(clientData);
                } else {
                    // Add new client
                    clientData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection('clients').add(clientData);
                }
                closeModal();
                loadClients();
            } catch (error) {
                console.error('Error saving client:', error);
                alert('Error saving client. Please try again.');
            }
        }

        async function deleteClient(clientId) {
            if (!confirm('Are you sure you want to delete this client?')) return;

            try {
                const db = firebase.firestore();
                await db.collection('clients').doc(clientId).delete();
                loadClients();
            } catch (error) {
                console.error('Error deleting client:', error);
                alert('Error deleting client. Please try again.');
            }
        }

        function closeModal() {
            document.getElementById('clientModal').classList.remove('show');
        }

        function formatDate(timestamp) {
            if (!timestamp) return '-';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString();
        }

        // Close modal on background click
        document.getElementById('clientModal').addEventListener('click', (e) => {
            if (e.target.id === 'clientModal') closeModal();
        });
    </script>
</body>
</html>
