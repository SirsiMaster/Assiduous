<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Commissions - Assiduous Agent Portal</title>
    
    <!-- Assiduous Design System -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fontsource/geist-sans@5.0.6/index.css" rel="stylesheet">
    
    <link rel="stylesheet" href="../assiduous.css">
    <link rel="stylesheet" href="../components/admin-layout.css">
    
    <!-- Canonical modular Firebase bootstrap for portal pages -->
    <script type="module">
        import Firebase, { AuthService, DatabaseService } from '../assets/js/firebase-init.js';
        window.Firebase = Firebase;
        window.AuthService = AuthService;
        window.DatabaseService = DatabaseService;
    </script>
    
    <style>
/* Sidebar */
        

        

        

        

        

        

        

        

        

        

        

        

        /* Main Content */
        

        /* Page Content */
        .page-content {
            flex: 1;
            padding: var(--space-xl);
            overflow-y: auto;
            background: var(--gray-50);
        }

        /* Commission Stats */
        .commission-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-lg);
            margin-bottom: var(--space-xl);
        }

        .stat-card {
            background: var(--white);
            padding: var(--space-lg);
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
        }

        .stat-card.featured {
            background: linear-gradient(135deg, var(--sky), var(--navy));
            color: var(--white);
            border: none;
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: var(--space-md);
        }

        .stat-card.featured .stat-icon {
            background: rgba(255, 255, 255, 0.2);
        }

        .stat-card:not(.featured) .stat-icon {
            background: var(--gray-100);
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: var(--space-xs);
        }

        .stat-card:not(.featured) .stat-value {
            color: var(--navy);
        }

        .stat-label {
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            opacity: 0.8;
        }

        .stat-change {
            margin-top: var(--space-sm);
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .stat-change.positive {
            color: var(--success);
        }

        .stat-change.negative {
            color: var(--danger);
        }

        .stat-card.featured .stat-change {
            color: rgba(255, 255, 255, 0.9);
        }

        /* Commission Table */
        .commission-table-container {
            background: var(--white);
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
            margin-bottom: var(--space-xl);
        }

        .table-header {
            padding: var(--space-lg);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--navy);
        }

        .table-filters {
            display: flex;
            gap: var(--space-sm);
        }

        .commission-table {
            width: 100%;
            border-collapse: collapse;
        }

        .commission-table th {
            text-align: left;
            padding: var(--space-md);
            background: var(--gray-50);
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border);
        }

        .commission-table td {
            padding: var(--space-md);
            border-bottom: 1px solid var(--border);
            font-size: 14px;
            color: var(--text-primary);
        }

        .commission-table tr:last-child td {
            border-bottom: none;
        }

        .commission-table tr:hover {
            background: var(--gray-50);
        }

        .property-info {
            font-weight: 600;
            color: var(--navy);
        }

        .property-address {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .commission-amount {
            font-weight: 700;
            color: var(--success);
        }

        .commission-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: var(--radius);
            font-size: 12px;
            font-weight: 500;
        }

        .commission-status.paid {
            background: rgba(34, 197, 94, 0.1);
            color: var(--success);
        }

        .commission-status.pending {
            background: rgba(251, 191, 36, 0.1);
            color: var(--warning);
        }

        .commission-status.processing {
            background: rgba(96, 163, 217, 0.1);
            color: var(--sky);
        }

        /* Charts Section */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: var(--space-lg);
        }

        .chart-container {
            background: var(--white);
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
            padding: var(--space-lg);
        }

        .chart-header {
            margin-bottom: var(--space-lg);
        }

        .chart-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--navy);
        }

        .chart-placeholder {
            height: 200px;
            background: var(--gray-50);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-size: 14px;
        }
    </style>
</head>
<body class="admin-wrapper" data-active="commissions">
    <!-- UCS Sidebar Component -->
    <aside class="sidebar" data-component="sidebar"></aside>

    <!-- Main Content Area -->
    <div class="main-content">
        <!-- UCS Header Component -->
        <header data-component="header"></header>

        <!-- Dashboard Content -->
        <div class="dashboard-content">
<!-- Commission Statistics -->
                <div class="commission-stats">
                    <div class="stat-card featured">
                        <div class="stat-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="1" x2="12" y2="23"></line>
                                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                            </svg>
                        </div>
                        <div class="stat-value" id="ytdCommission">$45,280</div>
                        <div class="stat-label">Year-to-Date Earnings</div>
                        <div class="stat-change positive">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                                <polyline points="17 6 23 6 23 12"></polyline>
                            </svg>
                            <span>+15.3% from last year</span>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                <line x1="8" y1="2" x2="8" y2="6"></line>
                                <line x1="3" y1="10" x2="21" y2="10"></line>
                            </svg>
                        </div>
                        <div class="stat-value" id="monthCommission">$8,450</div>
                        <div class="stat-label">This Month</div>
                        <div class="stat-change positive">
                            <span>+$2,300 from last month</span>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                        </div>
                        <div class="stat-value" id="pendingCommission">$12,500</div>
                        <div class="stat-label">Pending Payment</div>
                        <div class="stat-change">
                            <span>3 transactions</span>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 3h18v18H3zM12 8v8m-4-4h8"></path>
                            </svg>
                        </div>
                        <div class="stat-value" id="avgCommission">$3,773</div>
                        <div class="stat-label">Average Commission</div>
                        <div class="stat-change">
                            <span>Per transaction</span>
                        </div>
                    </div>
                </div>
                
                <!-- Recent Commissions Table -->
                <div class="commission-table-container">
                    </div>
                    
                    <table class="commission-table">
                        <thead>
                            <tr>
                                <th>Property</th>
                                <th>Transaction Type</th>
                                <th>Sale Price</th>
                                <th>Commission Rate</th>
                                <th>Commission</th>
                                <th>Status</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody id="commissionsTableBody">
                            <tr>
                                <td>
                                    <div class="property-info">123 Main Street</div>
                                    <div class="property-address">Los Angeles, CA 90210</div>
                                </td>
                                <td>Buyer Rep</td>
                                <td>$450,000</td>
                                <td>3%</td>
                                <td class="commission-amount">$13,500</td>
                                <td><span class="commission-status paid">Paid</span></td>
                                <td>Oct 5, 2025</td>
                            </tr>
                            <tr>
                                <td>
                                    <div class="property-info">456 Oak Avenue</div>
                                    <div class="property-address">Beverly Hills, CA 90212</div>
                                </td>
                                <td>Listing</td>
                                <td>$850,000</td>
                                <td>2.5%</td>
                                <td class="commission-amount">$21,250</td>
                                <td><span class="commission-status pending">Pending</span></td>
                                <td>Oct 8, 2025</td>
                            </tr>
                            <tr>
                                <td>
                                    <div class="property-info">789 Pine Road</div>
                                    <div class="property-address">Santa Monica, CA 90401</div>
                                </td>
                                <td>Dual Agency</td>
                                <td>$320,000</td>
                                <td>2%</td>
                                <td class="commission-amount">$6,400</td>
                                <td><span class="commission-status processing">Processing</span></td>
                                <td>Oct 9, 2025</td>
                            </tr>
                            <tr>
                                <td>
                                    <div class="property-info">321 Elm Street</div>
                                    <div class="property-address">Malibu, CA 90265</div>
                                </td>
                                <td>Buyer Rep</td>
                                <td>$1,200,000</td>
                                <td>2.5%</td>
                                <td class="commission-amount">$30,000</td>
                                <td><span class="commission-status paid">Paid</span></td>
                                <td>Sep 28, 2025</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Charts Section -->
                <div class="charts-grid">
                    <div class="chart-container">
                        <div style="height: 250px; position: relative;">
                            <canvas id="monthlyTrendChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <div style="height: 250px; position: relative;">
                            <canvas id="propertyTypeChart"></canvas>
                        </div>
                    </div>
                </div>
        </div>
    </div>

    <!-- UCS Core Scripts -->
    <script src="../components/ucs-core.js"></script>
    <script src="../components/component-registry.js"></script>
    <script src="../components/universal-header.js"></script>
    <script src="../components/auth-guard.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        // ==========================================
        // FIREBASE COMMISSION TRACKING SERVICE
        // ==========================================
        
        const CommissionService = {
            get db() {
                return window.firebaseDb || (window.Firebase && window.Firebase.db);
            },
            get auth() {
                return window.firebaseAuth || (window.Firebase && window.Firebase.auth);
            },
            
            /**
             * Get all commissions for current agent
             */
            async getCommissions() {
                try {
                    const user = this.auth.currentUser;
                    if (!user) throw new Error('Not authenticated');
                    
                    const snapshot = await this.db.collection('commissions')
                        .where('agentId', '==', user.uid)
                        .orderBy('date', 'desc')
                        .get();
                    
                    return snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data(),
                        date: doc.data().date?.toDate() || new Date()
                    }));
                } catch (error) {
                    console.error('Error fetching commissions:', error);
                    // Return demo data if Firebase fails
                    return this.getDemoCommissions();
                }
            },
            
            /**
             * Calculate commission statistics
             */
            calculateStats(commissions) {
                const now = new Date();
                const currentYear = now.getFullYear();
                const currentMonth = now.getMonth();
                
                // Year-to-date total
                const ytdCommissions = commissions.filter(c => {
                    const commDate = new Date(c.date);
                    return commDate.getFullYear() === currentYear && c.status === 'paid';
                });
                const ytdTotal = ytdCommissions.reduce((sum, c) => sum + (c.amount || 0), 0);
                
                // This month total
                const monthCommissions = commissions.filter(c => {
                    const commDate = new Date(c.date);
                    return commDate.getFullYear() === currentYear && 
                           commDate.getMonth() === currentMonth && 
                           c.status === 'paid';
                });
                const monthTotal = monthCommissions.reduce((sum, c) => sum + (c.amount || 0), 0);
                
                // Pending commissions
                const pendingCommissions = commissions.filter(c => 
                    c.status === 'pending' || c.status === 'processing'
                );
                const pendingTotal = pendingCommissions.reduce((sum, c) => sum + (c.amount || 0), 0);
                
                // Average commission
                const paidCommissions = commissions.filter(c => c.status === 'paid');
                const avgCommission = paidCommissions.length > 0 
                    ? paidCommissions.reduce((sum, c) => sum + (c.amount || 0), 0) / paidCommissions.length
                    : 0;
                
                return {
                    ytdTotal,
                    ytdCount: ytdCommissions.length,
                    monthTotal,
                    monthCount: monthCommissions.length,
                    pendingTotal,
                    pendingCount: pendingCommissions.length,
                    avgCommission,
                    totalTransactions: paidCommissions.length
                };
            },
            
            /**
             * Get monthly commission data for charts
             */
            getMonthlyData(commissions) {
                const monthlyData = {};
                const now = new Date();
                
                // Last 12 months
                for (let i = 11; i >= 0; i--) {
                    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                    const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                    monthlyData[key] = 0;
                }
                
                // Sum commissions by month
                commissions.filter(c => c.status === 'paid').forEach(c => {
                    const date = new Date(c.date);
                    const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    if (monthlyData.hasOwnProperty(key)) {
                        monthlyData[key] += (c.amount || 0);
                    }
                });
                
                return monthlyData;
            },
            
            /**
             * Get commission breakdown by property type
             */
            getPropertyTypeData(commissions) {
                const typeData = {};
                
                commissions.filter(c => c.status === 'paid').forEach(c => {
                    const type = c.propertyType || 'Other';
                    typeData[type] = (typeData[type] || 0) + (c.amount || 0);
                });
                
                return typeData;
            },
            
            /**
             * Demo data for development/fallback
             */
            getDemoCommissions() {
                return [
                    {
                        id: '1',
                        propertyAddress: '123 Main Street',
                        city: 'Los Angeles',
                        state: 'CA',
                        zip: '90210',
                        transactionType: 'Buyer Rep',
                        salePrice: 450000,
                        commissionRate: 3.0,
                        amount: 13500,
                        status: 'paid',
                        propertyType: 'Single Family',
                        date: new Date('2025-10-05')
                    },
                    {
                        id: '2',
                        propertyAddress: '456 Oak Avenue',
                        city: 'Beverly Hills',
                        state: 'CA',
                        zip: '90212',
                        transactionType: 'Listing',
                        salePrice: 850000,
                        commissionRate: 2.5,
                        amount: 21250,
                        status: 'pending',
                        propertyType: 'Condo',
                        date: new Date('2025-10-08')
                    },
                    {
                        id: '3',
                        propertyAddress: '789 Pine Road',
                        city: 'Santa Monica',
                        state: 'CA',
                        zip: '90401',
                        transactionType: 'Dual Agency',
                        salePrice: 320000,
                        commissionRate: 2.0,
                        amount: 6400,
                        status: 'processing',
                        propertyType: 'Townhouse',
                        date: new Date('2025-10-09')
                    },
                    {
                        id: '4',
                        propertyAddress: '321 Elm Street',
                        city: 'Malibu',
                        state: 'CA',
                        zip: '90265',
                        transactionType: 'Buyer Rep',
                        salePrice: 1200000,
                        commissionRate: 2.5,
                        amount: 30000,
                        status: 'paid',
                        propertyType: 'Single Family',
                        date: new Date('2025-09-28')
                    },
                    {
                        id: '5',
                        propertyAddress: '555 Beach Blvd',
                        city: 'Venice',
                        state: 'CA',
                        zip: '90291',
                        transactionType: 'Listing',
                        salePrice: 675000,
                        commissionRate: 3.0,
                        amount: 20250,
                        status: 'paid',
                        propertyType: 'Condo',
                        date: new Date('2025-09-15')
                    },
                    {
                        id: '6',
                        propertyAddress: '777 Sunset Drive',
                        city: 'West Hollywood',
                        state: 'CA',
                        zip: '90069',
                        transactionType: 'Buyer Rep',
                        salePrice: 425000,
                        commissionRate: 2.5,
                        amount: 10625,
                        status: 'paid',
                        propertyType: 'Single Family',
                        date: new Date('2025-08-22')
                    }
                ];
            },
            
            /**
             * Filter commissions by status
             */
            filterByStatus(commissions, status) {
                if (status === 'all') return commissions;
                return commissions.filter(c => c.status.toLowerCase() === status.toLowerCase());
            },
            
            /**
             * Export commissions to CSV
             */
            exportToCSV(commissions) {
                const headers = ['Property', 'City', 'Type', 'Sale Price', 'Rate', 'Commission', 'Status', 'Date'];
                const rows = commissions.map(c => [
                    c.propertyAddress,
                    `${c.city}, ${c.state}`,
                    c.transactionType,
                    `$${c.salePrice.toLocaleString()}`,
                    `${c.commissionRate}%`,
                    `$${c.amount.toLocaleString()}`,
                    c.status,
                    new Date(c.date).toLocaleDateString()
                ]);
                
                const csv = [headers, ...rows]
                    .map(row => row.join(','))
                    .join('\n');
                
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `commissions_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                URL.revokeObjectURL(url);
            }
        };
        
        // ==========================================
        // UI RENDERING FUNCTIONS
        // ==========================================
        
        /**
         * Update statistics cards
         */
        function updateStats(stats) {
            document.getElementById('ytdCommission').textContent = 
                `$${stats.ytdTotal.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}`;
            
            document.getElementById('monthCommission').textContent = 
                `$${stats.monthTotal.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}`;
            
            document.getElementById('pendingCommission').textContent = 
                `$${stats.pendingTotal.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}`;
            
            document.getElementById('avgCommission').textContent = 
                `$${stats.avgCommission.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}`;
        }
        
        /**
         * Render commission table
         */
        function renderCommissionTable(commissions) {
            const tbody = document.getElementById('commissionsTableBody');
            tbody.innerHTML = '';
            
            if (commissions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--text-secondary);">No commissions found</td></tr>';
                return;
            }
            
            commissions.forEach(commission => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div class="property-info">${commission.propertyAddress}</div>
                        <div class="property-address">${commission.city}, ${commission.state} ${commission.zip}</div>
                    </td>
                    <td>${commission.transactionType}</td>
                    <td>$${commission.salePrice.toLocaleString()}</td>
                    <td>${commission.commissionRate}%</td>
                    <td class="commission-amount">$${commission.amount.toLocaleString()}</td>
                    <td><span class="commission-status ${commission.status.toLowerCase()}">${commission.status.charAt(0).toUpperCase() + commission.status.slice(1)}</span></td>
                    <td>${new Date(commission.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        /**
         * Create monthly trend chart
         */
        let monthlyChart = null;
        function createMonthlyChart(monthlyData) {
            const ctx = document.getElementById('monthlyTrendChart');
            if (!ctx) return;
            
            const labels = Object.keys(monthlyData).map(key => {
                const [year, month] = key.split('-');
                return new Date(year, month - 1).toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
            });
            
            const data = Object.values(monthlyData);
            
            if (monthlyChart) {
                monthlyChart.destroy();
            }
            
            monthlyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Commission Earnings',
                        data: data,
                        borderColor: 'rgb(96, 163, 217)',
                        backgroundColor: 'rgba(96, 163, 217, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return '$' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000) + 'K';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        /**
         * Create property type chart
         */
        let propertyTypeChart = null;
        function createPropertyTypeChart(typeData) {
            const ctx = document.getElementById('propertyTypeChart');
            if (!ctx) return;
            
            const labels = Object.keys(typeData);
            const data = Object.values(typeData);
            
            if (propertyTypeChart) {
                propertyTypeChart.destroy();
            }
            
            propertyTypeChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            'rgb(96, 163, 217)',
                            'rgb(19, 55, 84)',
                            'rgb(251, 191, 36)',
                            'rgb(34, 197, 94)',
                            'rgb(239, 68, 68)'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: $${value.toLocaleString()} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // ==========================================
        // EVENT HANDLERS
        // ==========================================
        
        let allCommissions = [];
        let currentFilter = 'all';
        
        /**
         * Handle filter change
         */
        function handleFilterChange(event) {
            const status = event.target.value.toLowerCase().replace(' ', '');
            currentFilter = status === 'allstatus' ? 'all' : status;
            
            const filtered = CommissionService.filterByStatus(allCommissions, currentFilter);
            renderCommissionTable(filtered);
        }
        
        /**
         * Handle export button click
         */
        function handleExport() {
            const filtered = CommissionService.filterByStatus(allCommissions, currentFilter);
            CommissionService.exportToCSV(filtered);
        }
        
        // ==========================================
        // INITIALIZATION
        // ==========================================
        
        /**
         * Load all commission data and render UI
         */
        async function loadCommissionData() {
            try {
                // Fetch commissions
                allCommissions = await CommissionService.getCommissions();
                
                // Calculate statistics
                const stats = CommissionService.calculateStats(allCommissions);
                updateStats(stats);
                
                // Render table
                renderCommissionTable(allCommissions);
                
                // Get chart data
                const monthlyData = CommissionService.getMonthlyData(allCommissions);
                const typeData = CommissionService.getPropertyTypeData(allCommissions);
                
                // Render charts
                createMonthlyChart(monthlyData);
                createPropertyTypeChart(typeData);
                
            } catch (error) {
                console.error('Error loading commission data:', error);
            }
        }
        
        /**
         * Initialize page
         */
        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication
            firebase.auth().onAuthStateChanged(user => {
                if (!user) {
                    window.location.href = '/agent/login.html';
                    return;
                }
                
                // Load data
                loadCommissionData();
                
                // Attach event listeners
                const filterSelect = document.querySelector('.table-filters select');
                if (filterSelect) {
                    filterSelect.addEventListener('change', handleFilterChange);
                }
                
                const exportBtn = document.querySelector('.table-filters button');
                if (exportBtn) {
                    exportBtn.addEventListener('click', handleExport);
                }
            });
        });
    </script>
</body>
</html>
