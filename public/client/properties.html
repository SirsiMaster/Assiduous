<!DOCTYPE html>
<html lang="en" data-auth-protect="client,investor">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Browse Properties - Assiduous Client Portal</title>

  <!-- Assiduous Design System -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&display=swap" rel="stylesheet">
 
  <link rel="stylesheet" href="../assiduous.css">
  <link rel="stylesheet" href="../components/admin-layout.css">
 
  <!-- Canonical modular Firebase auth: used by AuthService and auth-guard -->
  <script type="module">
    import Firebase, { AuthService } from '../assets/js/firebase-init.js';
    // Expose for auth-guard and any modular-aware components
    window.Firebase = Firebase;
    window.AuthService = AuthService;
  </script>

  <style>
    .properties-layout {
      display: flex;
      flex-direction: column;
      gap: var(--space-lg);
    }
    .filters-card {
      background: var(--white);
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      padding: var(--space-lg);
      display: grid;
      grid-template-columns: 2fr 1fr 1fr 1fr 1fr auto;
      gap: var(--space-md);
      align-items: end;
    }
    .filters-card label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }
    .filters-card input,
    .filters-card select {
      width: 100%;
      padding: 8px 10px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      font-size: 14px;
    }
    .filters-card button.primary {
      padding: 10px 18px;
      border-radius: var(--radius);
      border: none;
      background: var(--sky);
      color: var(--white);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    .filters-card button.secondary {
      padding: 10px 18px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: var(--white);
      color: var(--text-secondary);
      font-size: 14px;
      cursor: pointer;
    }
    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .results-meta {
      font-size: 14px;
      color: var(--text-secondary);
    }
    .view-toggle {
      display: inline-flex;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      overflow: hidden;
    }
    .view-toggle button {
      padding: 6px 10px;
      border: none;
      background: var(--white);
      cursor: pointer;
      font-size: 14px;
    }
    .view-toggle button.active {
      background: var(--gray-100);
    }
    .properties-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: var(--space-lg);
    }
    .property-card {
      background: var(--white);
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      overflow: hidden;
      cursor: pointer;
      display: flex;
      flex-direction: column;
    }
    .property-image {
      height: 180px;
      background-size: cover;
      background-position: center;
    }
    .property-body {
      padding: var(--space-md);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .property-price {
      font-size: 18px;
      font-weight: 700;
      color: var(--navy);
    }
    .property-address {
      font-size: 14px;
      color: var(--text-secondary);
    }
    .property-meta {
      display: flex;
      gap: 12px;
      font-size: 12px;
      color: var(--text-secondary);
    }
    .save-pill {
      margin-left: auto;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 12px;
    }
    .loading-state,
    .empty-state {
      padding: var(--space-xl);
      text-align: center;
      color: var(--text-secondary);
    }
  </style>
</head>
<body class="admin-wrapper" data-active="properties">
  <!-- UCS Sidebar Component -->
  <aside class="sidebar" data-component="sidebar"></aside>

  <!-- Main Content Area -->
  <div class="main-content">
    <!-- UCS Header Component -->
    <header data-component="header"></header>

    <!-- Dashboard Content -->
    <div class="dashboard-content">
      <h1 class="page-title">Browse Properties</h1>
      <p class="page-subtitle">Explore properties available on the Assiduous platform</p>

      <div class="properties-layout">
        <div class="filters-card">
          <div>
            <label for="searchInput">Search</label>
            <input id="searchInput" type="text" placeholder="Search by address, city" />
          </div>
          <div>
            <label for="typeFilter">Property Type</label>
            <select id="typeFilter">
              <option value="any">All Types</option>
              <option value="single_family">Single Family</option>
              <option value="multi_family">Multi-Family</option>
              <option value="condo">Condo</option>
              <option value="townhouse">Townhouse</option>
            </select>
          </div>
          <div>
            <label for="priceFilter">Price Range</label>
            <select id="priceFilter">
              <option value="any">Any Price</option>
              <option value="0-250000">Under $250k</option>
              <option value="250000-500000">$250k - $500k</option>
              <option value="500000-750000">$500k - $750k</option>
              <option value="750000-1000000">$750k - $1M</option>
              <option value="1000000-99999999">$1M+</option>
            </select>
          </div>
          <div>
            <label for="bedsFilter">Bedrooms</label>
            <select id="bedsFilter">
              <option value="any">Any</option>
              <option value="1">1+</option>
              <option value="2">2+</option>
              <option value="3">3+</option>
              <option value="4">4+</option>
            </select>
          </div>
          <div>
            <label for="bathsFilter">Bathrooms</label>
            <select id="bathsFilter">
              <option value="any">Any</option>
              <option value="1">1+</option>
              <option value="2">2+</option>
              <option value="3">3+</option>
            </select>
          </div>
          <div style="display:flex; gap:8px;">
            <button class="primary" id="applyFiltersBtn">Search</button>
            <button class="secondary" id="clearFiltersBtn">Clear Filters</button>
          </div>
        </div>

        <div class="results-header">
          <div class="results-meta" id="resultsMeta">Loading properties…</div>
          <div class="view-toggle">
            <button id="viewGridBtn" class="active">Grid</button>
            <button id="viewListBtn">List</button>
          </div>
        </div>

        <div id="loadingState" class="loading-state">Loading properties from the marketplace…</div>
        <div id="emptyState" class="empty-state" style="display:none;">No properties match your criteria.</div>

        <div id="propertiesGrid" class="properties-grid" style="display:none;"></div>
        <div id="propertiesList" style="display:none;"></div>
      </div>
  </div>
  </div>
 
  <!-- UCS Core Scripts (match client dashboard) -->
  <script src="../components/ucs-core.js"></script>
  <script src="../components/component-registry.js"></script>
  <script src="../components/auth-guard.js"></script>
 
  <script>
    (function () {
      var state = {
        currentView: 'grid',
        allProperties: [],
        filtered: [],
      };

      var propertyService = null;

      function normalizeProperty(p) {
        if (!p) return null;
        var addressObj = p.address || {};
        return Object.assign({}, p, {
          id: p.id,
          address:
            addressObj.street || addressObj.line1 || p.addressLine1 || p.address || '',
          city: addressObj.city || p.city || '',
          state: addressObj.state || p.state || '',
          zipCode: addressObj.zip || addressObj.postalCode || p.zipCode || p.postalCode || '',
          price:
            typeof p.price === 'object'
              ? p.price.list != null
                ? p.price.list
                : p.price.arv != null
                ? p.price.arv
                : 0
              : p.price || 0,
          bedrooms: p.bedrooms != null ? p.bedrooms : p.beds != null ? p.beds : null,
          bathrooms:
            p.bathrooms != null ? p.bathrooms : p.baths != null ? p.baths : null,
          sqft: p.sqft != null ? p.sqft : p.squareFeet != null ? p.squareFeet : null,
          image:
            p.image ||
            (Array.isArray(p.images) && p.images.length ? p.images[0] : p.primaryImageUrl || ''),
        });
      }

      function getFilterValues() {
        var search = document.getElementById('searchInput').value.trim().toLowerCase();
        var type = document.getElementById('typeFilter').value;
        var price = document.getElementById('priceFilter').value;
        var beds = document.getElementById('bedsFilter').value;
        var baths = document.getElementById('bathsFilter').value;

        var priceMin = null;
        var priceMax = null;
        if (price && price !== 'any') {
          var parts = price.split('-');
          priceMin = parseInt(parts[0], 10);
          priceMax = parseInt(parts[1], 10);
        }

        return { search, type, priceMin, priceMax, beds, baths };
      }

      function applyClientFilters() {
        var filters = getFilterValues();
        var props = state.allProperties.slice();

        if (filters.search) {
          props = props.filter(function (p) {
            var haystack = [p.address, p.city, p.state, p.zipCode]
              .filter(Boolean)
              .join(' ')
              .toLowerCase();
            return haystack.indexOf(filters.search) !== -1;
          });
        }

        if (filters.type && filters.type !== 'any') {
          props = props.filter(function (p) {
            return (p.type || '').toLowerCase() === filters.type.toLowerCase();
          });
        }

        if (filters.priceMin != null && filters.priceMax != null) {
          props = props.filter(function (p) {
            var price = p.price || 0;
            return price >= filters.priceMin && price <= filters.priceMax;
          });
        }

        if (filters.beds && filters.beds !== 'any') {
          var bedsMin = parseInt(filters.beds, 10);
          props = props.filter(function (p) {
            return (p.bedrooms || 0) >= bedsMin;
          });
        }

        if (filters.baths && filters.baths !== 'any') {
          var bathsMin = parseInt(filters.baths, 10);
          props = props.filter(function (p) {
            return (p.bathrooms || 0) >= bathsMin;
          });
        }

        state.filtered = props;
        renderResults();
      }

      function renderResults() {
        var loadingEl = document.getElementById('loadingState');
        var emptyEl = document.getElementById('emptyState');
        var gridEl = document.getElementById('propertiesGrid');
        var listEl = document.getElementById('propertiesList');
        var metaEl = document.getElementById('resultsMeta');

        loadingEl.style.display = 'none';

        if (!state.filtered.length) {
          gridEl.style.display = 'none';
          listEl.style.display = 'none';
          emptyEl.style.display = 'block';
          metaEl.textContent = '0 properties match your filters.';
          return;
        }

        emptyEl.style.display = 'none';
        metaEl.textContent = state.filtered.length + ' properties found';

        if (state.currentView === 'grid') {
          gridEl.style.display = 'grid';
          listEl.style.display = 'none';

          gridEl.innerHTML = state.filtered
            .map(function (p) {
              var address = [p.address, p.city, p.state, p.zipCode]
                .filter(Boolean)
                .join(', ');
              var price = typeof p.price === 'number' ? '$' + p.price.toLocaleString() : '—';
              var beds = p.bedrooms != null ? p.bedrooms + ' bd' : '';
              var baths = p.bathrooms != null ? p.bathrooms + ' ba' : '';
              var sqft = p.sqft != null ? p.sqft.toLocaleString() + ' sqft' : '';
              var meta = [beds, baths, sqft].filter(Boolean).join(' • ');

              return (
                '<div class="property-card" data-id="' + p.id + '">' +
                '<div class="property-image" style="background-image:url(' +
                (p.image || '\'/assets/img/property-placeholder.jpg\'') + ');"></div>' +
                '<div class="property-body">' +
                '<div class="property-price">' + price + '</div>' +
                '<div class="property-address">' + address + '</div>' +
                '<div class="property-meta">' + meta + '</div>' +
                '</div>' +
                '</div>'
              );
            })
            .join('');

          Array.prototype.forEach.call(gridEl.querySelectorAll('.property-card'), function (card) {
            card.addEventListener('click', function () {
              var id = this.getAttribute('data-id');
              if (!id) return;
              window.location.href = 'property-detail.html?id=' + encodeURIComponent(id);
            });
          });
        } else {
          // Simple list view reuses same markup for now
          listEl.style.display = 'block';
          gridEl.style.display = 'none';
          listEl.innerHTML =
            '<p style="padding:16px; color: var(--text-secondary);">List view coming soon.</p>';
        }
      }

      function setView(view) {
        state.currentView = view;
        document.getElementById('viewGridBtn').classList.toggle('active', view === 'grid');
        document.getElementById('viewListBtn').classList.toggle('active', view === 'list');
        renderResults();
      }

      function wireEvents() {
        document.getElementById('applyFiltersBtn').addEventListener('click', function () {
          applyClientFilters();
        });
        document.getElementById('clearFiltersBtn').addEventListener('click', function () {
          document.getElementById('searchInput').value = '';
          document.getElementById('typeFilter').value = 'any';
          document.getElementById('priceFilter').value = 'any';
          document.getElementById('bedsFilter').value = 'any';
          document.getElementById('bathsFilter').value = 'any';
          state.filtered = state.allProperties.slice();
          renderResults();
        });
        document.getElementById('viewGridBtn').addEventListener('click', function () {
          setView('grid');
        });
        document.getElementById('viewListBtn').addEventListener('click', function () {
          setView('list');
        });
      }

      async function loadPropertiesForUser() {
        var loadingEl = document.getElementById('loadingState');
        loadingEl.style.display = 'block';

        try {
          if (!propertyService) {
            console.error('[Client Properties] PropertyService not ready');
            state.allProperties = [];
          } else {
            var result = await propertyService.getProperties({ status: 'available', limit: 100 });
            var list = (result && result.properties) || [];
            state.allProperties = list
              .map(normalizeProperty)
              .filter(function (p) {
                return p !== null;
              });
          }
        } catch (e) {
          console.error('[Client Properties] Failed to load properties:', e);
          state.allProperties = [];
        }

        state.filtered = state.allProperties.slice();
        applyClientFilters();
      }

      // Wait for Firebase + auth and then bootstrap PropertyService
      window.addEventListener('firebase-ready', function () {
        var authInstance = (window.Firebase && window.Firebase.auth) || window.firebaseAuth;
        if (!authInstance || typeof authInstance.onAuthStateChanged !== 'function') {
          console.warn('[Client Properties] Auth not ready; rendering anonymous view');
          state.allProperties = [];
          state.filtered = [];
          renderResults();
          wireEvents();
          return;
        }

        // Dynamic import to keep bundle light and reuse admin logic
        import('../assets/js/services/propertyservice.js')
          .then(function (module) {
            propertyService = new module.PropertyService();
            wireEvents();
            authInstance.onAuthStateChanged(function (user) {
              if (!user) {
                state.allProperties = [];
                state.filtered = [];
                renderResults();
                return;
              }
              loadPropertiesForUser();
            });
          })
          .catch(function (err) {
            console.error('[Client Properties] Failed to load PropertyService:', err);
            wireEvents();
            state.allProperties = [];
            state.filtered = [];
            renderResults();
          });
      });
    })();
  </script>
</body>
</html>
