<!DOCTYPE html>
<html lang="en" data-auth-protect="client,investor">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Browse Properties - Assiduous Client Portal</title>

  <!-- Assiduous Design System -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&display=swap" rel="stylesheet">
 
  <link rel="stylesheet" href="../assiduous.css">
  <link rel="stylesheet" href="../components/admin-layout.css">
 
  <!-- Canonical modular Firebase auth: used by AuthService and auth-guard -->
  <script type="module">
    import Firebase, { AuthService } from '../assets/js/firebase-init.js';
    // Expose for auth-guard and any modular-aware components
    window.Firebase = Firebase;
    window.AuthService = AuthService;
  </script>

  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    .properties-layout {
      display: flex;
      flex-direction: column;
      gap: var(--space-lg);
    }
    .filters-card {
      background: var(--white);
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      padding: var(--space-lg);
      display: grid;
      grid-template-columns: 2fr 1fr 1fr 1fr 1fr 1fr auto;
      gap: var(--space-md);
      align-items: end;
    }
    .filters-card label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }
    .filters-card input,
    .filters-card select {
      width: 100%;
      padding: 8px 10px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      font-size: 14px;
    }
    .filters-card button.primary {
      padding: 10px 18px;
      border-radius: var(--radius);
      border: none;
      background: var(--sky);
      color: var(--white);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    .filters-card button.secondary {
      padding: 10px 18px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: var(--white);
      color: var(--text-secondary);
      font-size: 14px;
      cursor: pointer;
    }
    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .properties-map {
      margin-top: var(--space-md);
      margin-bottom: var(--space-xl);
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      overflow: hidden;
      height: 320px;
    }
    .results-meta {
      font-size: 14px;
      color: var(--text-secondary);
    }
    .view-toggle {
      display: inline-flex;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      overflow: hidden;
    }
    .view-toggle button {
      padding: 6px 10px;
      border: none;
      background: var(--white);
      cursor: pointer;
      font-size: 14px;
    }
    .view-toggle button.active {
      background: var(--gray-100);
    }
    .properties-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: var(--space-lg);
    }
    .property-card {
      background: var(--white);
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      overflow: hidden;
      cursor: pointer;
      display: flex;
      flex-direction: column;
    }
    .property-image {
      height: 180px;
      background-size: cover;
      background-position: center;
    }
    .property-body {
      padding: var(--space-md);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .property-price {
      font-size: 18px;
      font-weight: 700;
      color: var(--navy);
    }
    .property-address {
      font-size: 14px;
      color: var(--text-secondary);
    }
    .property-meta {
      display: flex;
      gap: 12px;
      font-size: 12px;
      color: var(--text-secondary);
    }
    .save-pill {
      margin-left: auto;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 12px;
    }
    .roi-pill {
      display: inline-flex;
      align-items: center;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      border: 1px solid transparent;
      margin-left: 4px;
    }
    .roi-high {
      background: rgba(16, 185, 129, 0.12);
      color: #047857;
      border-color: rgba(16, 185, 129, 0.4);
    }
    .roi-medium {
      background: rgba(14, 165, 233, 0.12);
      color: #0369a1;
      border-color: rgba(14, 165, 233, 0.4);
    }
    .roi-low {
      background: rgba(234, 179, 8, 0.12);
      color: #92400e;
      border-color: rgba(234, 179, 8, 0.4);
    }
    .roi-thin {
      background: rgba(148, 163, 184, 0.18);
      color: #475569;
      border-color: rgba(148, 163, 184, 0.4);
    }
    .loading-state,
    .empty-state {
      padding: var(--space-xl);
      text-align: center;
      color: var(--text-secondary);
    }
    .roi-legend {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--text-secondary);
    }
    .roi-legend-label {
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
  </style>
</head>
<body class="admin-wrapper" data-active="properties">
  <!-- UCS Sidebar Component -->
  <aside class="sidebar" data-component="sidebar"></aside>

  <!-- Main Content Area -->
  <div class="main-content">
    <!-- UCS Header Component -->
    <header data-component="header"></header>

    <!-- Dashboard Content -->
    <div class="dashboard-content">
      <h1 class="page-title">Browse Properties</h1>
      <p class="page-subtitle">Explore properties available on the Assiduous platform</p>

      <div class="properties-layout">
        <div class="filters-card">
          <div>
            <label for="searchInput">Search</label>
            <input id="searchInput" type="text" placeholder="Search by address, city" />
          </div>
          <div>
            <label for="typeFilter">Property Type</label>
            <select id="typeFilter">
              <option value="any">All Types</option>
              <option value="single_family">Single Family</option>
              <option value="multi_family">Multi-Family</option>
              <option value="condo">Condo</option>
              <option value="townhouse">Townhouse</option>
            </select>
          </div>
          <div>
            <label for="priceFilter">Price Range</label>
            <select id="priceFilter">
              <option value="any">Any Price</option>
              <option value="0-250000">Under $250k</option>
              <option value="250000-500000">$250k - $500k</option>
              <option value="500000-750000">$500k - $750k</option>
              <option value="750000-1000000">$750k - $1M</option>
              <option value="1000000-99999999">$1M+</option>
            </select>
          </div>
          <div>
            <label for="bedsFilter">Bedrooms</label>
            <select id="bedsFilter">
              <option value="any">Any</option>
              <option value="1">1+</option>
              <option value="2">2+</option>
              <option value="3">3+</option>
              <option value="4">4+</option>
            </select>
          </div>
          <div>
            <label for="bathsFilter">Bathrooms</label>
            <select id="bathsFilter">
              <option value="any">Any</option>
              <option value="1">1+</option>
              <option value="2">2+</option>
              <option value="3">3+</option>
            </select>
          </div>
          <div>
            <label for="radiusFilter">Radius (mi from map center)</label>
            <input
              id="radiusFilter"
              type="number"
              min="0"
              max="100"
              placeholder="e.g. 10"
            />
          </div>
          <div style="display:flex; gap:8px;">
            <button class="primary" id="applyFiltersBtn">Search</button>
            <button class="secondary" id="clearFiltersBtn">Clear Filters</button>
          </div>
        </div>

        <div class="results-header">
          <div class="results-meta" id="resultsMeta">Loading properties…</div>
          <div class="view-toggle">
            <button id="viewGridBtn" class="active">Grid</button>
            <button id="viewListBtn">List</button>
          </div>
        </div>

        <div class="roi-legend" aria-label="Micro-flip ROI legend">
          <span class="roi-legend-label">Micro-flip ROI</span>
          <span class="roi-pill roi-high">High ≥ 25%</span>
          <span class="roi-pill roi-medium">Medium 15–24%</span>
          <span class="roi-pill roi-low">Low 5–14%</span>
          <span class="roi-pill roi-thin">Thin &lt; 5%</span>
        </div>

        <div id="loadingState" class="loading-state">Loading properties from the marketplace…</div>
        <div id="emptyState" class="empty-state" style="display:none;">No properties match your criteria.</div>

        <div id="radiusSummary" class="results-meta" style="font-size:12px; display:none;"></div>
        <div id="propertiesMap" class="properties-map" style="display:none;"></div>

        <div id="propertiesGrid" class="properties-grid" style="display:none;"></div>
        <div id="propertiesList" style="display:none;"></div>
      </div>
  </div>
  </div>
 
  <!-- UCS Core Scripts (match client dashboard) -->
  <script src="../components/ucs-core.js"></script>
  <script src="../components/component-registry.js"></script>
  <script src="../components/auth-guard.js"></script>
  <script src="../assets/js/services/guide-engine.js"></script>
 
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>

  <script>
    (function () {
      var state = {
        currentView: 'grid',
        allProperties: [],
        filtered: [],
        radiusMiles: null,
        mapCenter: null,
      };

      var map = null;
      var mapMarkers = [];
      var mapInitialized = false;

      var propertyService = null;

      function computePreviewMicroflip(price, arv, repairs) {
        price = typeof price === 'number' ? price : 0;
        arv = typeof arv === 'number' ? arv : 0;
        repairs = typeof repairs === 'number' ? repairs : 0;
        if (!price || !arv) {
          return { roi: null, profit: null };
        }

        // Mirror Go engine defaults for a 90-day, cash micro-flip scenario.
        var holdingDays = 90;
        var months = holdingDays / 30;

        // Acquisition: purchase + 2.5% closing costs
        var closingCosts = price * 0.025;

        // Holding: taxes (1.2% annual) + insurance (0.5% annual), utilities omitted for preview
        var taxCosts = (price * 0.012 / 12) * months;
        var insuranceCosts = (price * 0.005 / 12) * months;
        var utilityCosts = 0;
        var holdingCosts = taxCosts + insuranceCosts + utilityCosts;

        // Exit: 8% of ARV (6% commission + 2% misc), matching Go engine default
        var exitCosts = arv * 0.08;

        var totalInvestment = price + closingCosts + repairs + holdingCosts;
        var totalCosts = totalInvestment + exitCosts;
        var netProfit = arv - totalCosts;
        var roi = totalInvestment > 0 ? (netProfit / totalInvestment) * 100 : null;

        return { roi: roi, profit: netProfit };
      }

      function normalizeProperty(p) {
        if (!p) return null;
        var addressObj = p.address || {};
        var coords = addressObj.coordinates || p.coordinates || null;
        var lat = null;
        var lng = null;
        if (coords) {
          // Firestore GeoPoint or plain object
          lat = typeof coords.latitude === 'number' ? coords.latitude : coords._lat;
          lng = typeof coords.longitude === 'number' ? coords.longitude : coords._long;
        }

        var basePrice =
          typeof p.price === 'object'
            ? p.price.list != null
              ? p.price.list
              : p.price.arv != null
              ? p.price.arv
              : 0
            : p.price || 0;

        var arv = p.estimatedARV || p.arv || (p.price && p.price.arv) || basePrice * 1.2;
        var repairs =
          p.estimatedRepairs ||
          p.repairCosts ||
          (p.price && p.price.repair) ||
          Math.round(basePrice * 0.15);

        var preview = computePreviewMicroflip(basePrice, arv, repairs);
        var roi = preview.roi;
        var profit = preview.profit;

        var roiBucket = null;
        if (roi != null) {
          if (roi >= 25) roiBucket = 'high';
          else if (roi >= 15) roiBucket = 'medium';
          else if (roi >= 5) roiBucket = 'low';
          else roiBucket = 'thin';
        }

        return Object.assign({}, p, {
          id: p.id,
          address:
            addressObj.street || addressObj.line1 || p.addressLine1 || p.address || '',
          city: addressObj.city || p.city || '',
          state: addressObj.state || p.state || '',
          zipCode: addressObj.zip || addressObj.postalCode || p.zipCode || p.postalCode || '',
          latitude: typeof lat === 'number' ? lat : null,
          longitude: typeof lng === 'number' ? lng : null,
          price: basePrice,
          bedrooms: p.bedrooms != null ? p.bedrooms : p.beds != null ? p.beds : null,
          bathrooms:
            p.bathrooms != null ? p.bathrooms : p.baths != null ? p.baths : null,
          sqft: p.sqft != null ? p.sqft : p.squareFeet != null ? p.squareFeet : null,
          microFlipRoi: roi,
          microFlipProfit: profit,
          microFlipBucket: roiBucket,
          image:
            p.image ||
            (Array.isArray(p.images) && p.images.length ? p.images[0] : p.primaryImageUrl || ''),
        });
      }

      function getFilterValues() {
        var search = document.getElementById('searchInput').value.trim().toLowerCase();
        var type = document.getElementById('typeFilter').value;
        var price = document.getElementById('priceFilter').value;
        var beds = document.getElementById('bedsFilter').value;
        var baths = document.getElementById('bathsFilter').value;
        var radiusInput = document.getElementById('radiusFilter');

        var priceMin = null;
        var priceMax = null;
        if (price && price !== 'any') {
          var parts = price.split('-');
          priceMin = parseInt(parts[0], 10);
          priceMax = parseInt(parts[1], 10);
        }

        var radiusMiles = null;
        if (radiusInput && radiusInput.value) {
          var r = parseFloat(radiusInput.value);
          if (!isNaN(r) && r > 0) {
            radiusMiles = r;
          }
        }
        state.radiusMiles = radiusMiles;

        return { search, type, priceMin, priceMax, beds, baths, radiusMiles };
      }

      function haversineMiles(lat1, lon1, lat2, lon2) {
        function toRad(d) {
          return (d * Math.PI) / 180;
        }
        var R = 3958.8; // miles
        var dLat = toRad(lat2 - lat1);
        var dLon = toRad(lon2 - lon1);
        var a =
          Math.sin(dLat / 2) * Math.sin(dLat / 2) +
          Math.cos(toRad(lat1)) *
            Math.cos(toRad(lat2)) *
            Math.sin(dLon / 2) *
            Math.sin(dLon / 2);
        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
      }

      function updateRadiusSummary() {
        var el = document.getElementById('radiusSummary');
        if (!el) return;
        if (!state.radiusMiles || !state.mapCenter) {
          el.style.display = 'none';
          el.textContent = '';
          return;
        }
        var lat = state.mapCenter.lat != null ? state.mapCenter.lat.toFixed(4) : null;
        var lng = state.mapCenter.lng != null ? state.mapCenter.lng.toFixed(4) : null;
        el.style.display = 'block';
        if (lat != null && lng != null) {
          el.textContent = 'Radius filter: ' + state.radiusMiles + ' mi around ' + lat + ', ' + lng;
        } else {
          el.textContent = 'Radius filter: ' + state.radiusMiles + ' mi from map center';
        }
      }

      function applyClientFilters() {
        var filters = getFilterValues();
        var props = state.allProperties.slice();

        if (filters.search) {
          props = props.filter(function (p) {
            var haystack = [p.address, p.city, p.state, p.zipCode]
              .filter(Boolean)
              .join(' ')
              .toLowerCase();
            return haystack.indexOf(filters.search) !== -1;
          });
        }

        if (filters.type && filters.type !== 'any') {
          props = props.filter(function (p) {
            return (p.type || '').toLowerCase() === filters.type.toLowerCase();
          });
        }

        if (filters.priceMin != null && filters.priceMax != null) {
          props = props.filter(function (p) {
            var price = p.price || 0;
            return price >= filters.priceMin && price <= filters.priceMax;
          });
        }

        if (filters.beds && filters.beds !== 'any') {
          var bedsMin = parseInt(filters.beds, 10);
          props = props.filter(function (p) {
            return (p.bedrooms || 0) >= bedsMin;
          });
        }

        if (filters.baths && filters.baths !== 'any') {
          var bathsMin = parseInt(filters.baths, 10);
          props = props.filter(function (p) {
            return (p.bathrooms || 0) >= bathsMin;
          });
        }

        if (filters.radiusMiles && state.mapCenter) {
          var centerLat = state.mapCenter.lat;
          var centerLng = state.mapCenter.lng;
          props = props.filter(function (p) {
            if (typeof p.latitude !== 'number' || typeof p.longitude !== 'number') {
              return false;
            }
            var d = haversineMiles(centerLat, centerLng, p.latitude, p.longitude);
            return d <= filters.radiusMiles;
          });
        }

        state.filtered = props;
        renderResults();
      }

      function renderResults() {
        var loadingEl = document.getElementById('loadingState');
        var emptyEl = document.getElementById('emptyState');
        var gridEl = document.getElementById('propertiesGrid');
        var listEl = document.getElementById('propertiesList');
        var metaEl = document.getElementById('resultsMeta');
        var mapEl = document.getElementById('propertiesMap');

        loadingEl.style.display = 'none';

        if (!state.filtered.length) {
          gridEl.style.display = 'none';
          listEl.style.display = 'none';
          emptyEl.style.display = 'block';
          metaEl.textContent = '0 properties match your filters.';
          if (mapEl) {
            mapEl.style.display = 'none';
          }
          updateRadiusSummary();
          return;
        }

        emptyEl.style.display = 'none';
        metaEl.textContent = state.filtered.length + ' properties found';
        updateRadiusSummary();

        renderMap();

        if (state.currentView === 'grid') {
          gridEl.style.display = 'grid';
          listEl.style.display = 'none';

          gridEl.innerHTML = state.filtered
            .map(function (p) {
              var address = [p.address, p.city, p.state, p.zipCode]
                .filter(Boolean)
                .join(', ');
              var price = typeof p.price === 'number' ? '$' + p.price.toLocaleString() : '—';
              var beds = p.bedrooms != null ? p.bedrooms + ' bd' : '';
              var baths = p.bathrooms != null ? p.bathrooms + ' ba' : '';
              var sqft = p.sqft != null ? p.sqft.toLocaleString() + ' sqft' : '';
              var meta = [beds, baths, sqft].filter(Boolean).join(' • ');
              var roiBadge = '';
              if (typeof p.microFlipRoi === 'number' && p.microFlipBucket) {
                var cls = p.microFlipBucket === 'high'
                  ? 'roi-pill roi-high'
                  : p.microFlipBucket === 'medium'
                  ? 'roi-pill roi-medium'
                  : p.microFlipBucket === 'low'
                  ? 'roi-pill roi-low'
                  : 'roi-pill roi-thin';
                roiBadge = '<span class="' + cls + '">ROI ' + p.microFlipRoi.toFixed(1) + '%</span>';
              }

              return (
                '<div class="property-card" data-id="' + p.id + '">' +
                '<div class="property-image" style="background-image:url(' +
                (p.image || '\'/assets/img/property-placeholder.jpg\'') + ');"></div>' +
                '<div class="property-body">' +
                '<div class="property-price">' + price + (roiBadge ? ' ' + roiBadge : '') + '</div>' +
                '<div class="property-address">' + address + '</div>' +
                '<div class="property-meta">' + meta + '</div>' +
                '</div>' +
                '</div>'
              );
            })
            .join('');

          Array.prototype.forEach.call(gridEl.querySelectorAll('.property-card'), function (card) {
            card.addEventListener('click', function () {
              var id = this.getAttribute('data-id');
              if (!id) return;
              window.location.href = 'property-detail.html?id=' + encodeURIComponent(id);
            });
          });
        } else {
          // Simple list view reuses same markup for now
          listEl.style.display = 'block';
          gridEl.style.display = 'none';
          listEl.innerHTML =
            '<p style="padding:16px; color: var(--text-secondary);">List view coming soon.</p>';
        }
      }

      function renderMap() {
        var mapEl = document.getElementById('propertiesMap');
        if (!mapEl || typeof L === 'undefined') {
          return;
        }

        var withCoords = state.filtered.filter(function (p) {
          return typeof p.latitude === 'number' && typeof p.longitude === 'number';
        });

        if (!withCoords.length) {
          mapEl.style.display = 'none';
          return;
        }

        mapEl.style.display = 'block';

        if (!mapInitialized) {
          map = L.map('propertiesMap').setView([39.9526, -75.1652], 12);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors',
          }).addTo(map);
          map.on('moveend', function () {
            state.mapCenter = map.getCenter();
            // Reapply filters when center moves and radius is set
            if (state.radiusMiles) {
              applyClientFilters();
            }
          });
          mapInitialized = true;
        }

        state.mapCenter = map.getCenter();

        // Clear old markers
        mapMarkers.forEach(function (m) {
          map.removeLayer(m);
        });
        mapMarkers = [];

        var bounds = [];
        withCoords.forEach(function (p) {
          var marker = L.marker([p.latitude, p.longitude]).addTo(map);
          var addr = [p.address, p.city, p.state, p.zipCode].filter(Boolean).join(', ');
          var price = typeof p.price === 'number' ? '$' + p.price.toLocaleString() : '';
          var roiText = '';
          var roiClass = '';
          if (typeof p.microFlipRoi === 'number' && p.microFlipBucket) {
            roiText = 'ROI ' + p.microFlipRoi.toFixed(1) + '%';
            if (p.microFlipBucket === 'high') roiClass = 'roi-pill roi-high';
            else if (p.microFlipBucket === 'medium') roiClass = 'roi-pill roi-medium';
            else if (p.microFlipBucket === 'low') roiClass = 'roi-pill roi-low';
            else roiClass = 'roi-pill roi-thin';
          }
          var roiHtml = roiText ? '<br/><span class="' + roiClass + '">' + roiText + '</span>' : '';
          var detailHref = p.id
            ? 'property-detail.html?id=' + encodeURIComponent(p.id) + '#microflip'
            : null;
          var ctaHtml = detailHref
            ? '<br/><a href="' +
              detailHref +
              '" style="font-size:12px; color:#0f766e; text-decoration:underline;">Analyze micro-flip  3F</a>'
            : '';
          marker.bindPopup('<strong>' + price + '</strong><br/>' + addr + roiHtml + ctaHtml);
          marker.on('click', function () {
            if (p.id) {
              window.location.href = 'property-detail.html?id=' + encodeURIComponent(p.id);
            }
          });
          mapMarkers.push(marker);
          bounds.push([p.latitude, p.longitude]);
        });

        if (bounds.length) {
          map.fitBounds(bounds, { padding: [20, 20] });
        }
      }

      function setView(view) {
        state.currentView = view;
        document.getElementById('viewGridBtn').classList.toggle('active', view === 'grid');
        document.getElementById('viewListBtn').classList.toggle('active', view === 'list');
        renderResults();
      }

      function wireEvents() {
        document.getElementById('applyFiltersBtn').addEventListener('click', function () {
          applyClientFilters();
        });
        document.getElementById('clearFiltersBtn').addEventListener('click', function () {
          document.getElementById('searchInput').value = '';
          document.getElementById('typeFilter').value = 'any';
          document.getElementById('priceFilter').value = 'any';
          document.getElementById('bedsFilter').value = 'any';
          document.getElementById('bathsFilter').value = 'any';
          var radiusInput = document.getElementById('radiusFilter');
          if (radiusInput) radiusInput.value = '';
          state.radiusMiles = null;
          state.filtered = state.allProperties.slice();
          renderResults();
        });
        document.getElementById('viewGridBtn').addEventListener('click', function () {
          setView('grid');
        });
        document.getElementById('viewListBtn').addEventListener('click', function () {
          setView('list');
        });
      }

      async function loadPropertiesForUser() {
        var loadingEl = document.getElementById('loadingState');
        loadingEl.style.display = 'block';

        try {
          if (!propertyService) {
            console.error('[Client Properties] PropertyService not ready');
            state.allProperties = [];
          } else {
            var result = await propertyService.getProperties({ status: 'available', limit: 100 });
            var list = (result && result.properties) || [];
            state.allProperties = list
              .map(normalizeProperty)
              .filter(function (p) {
                return p !== null;
              });
          }
        } catch (e) {
          console.error('[Client Properties] Failed to load properties:', e);
          state.allProperties = [];
        }

        state.filtered = state.allProperties.slice();
        applyClientFilters();
      }

      // Wait for Firebase + auth and then bootstrap PropertyService
      window.addEventListener('firebase-ready', function () {
        // Register guided walkthrough for property search
        if (window.AssiduousGuide) {
          window.AssiduousGuide.register('client-properties', {
            title: 'Property search walkthrough',
            steps: [
              {
                id: 'props-filters',
                selector: '.filters-card',
                title: 'Search filters',
                body: 'Start by narrowing results by location, price range, bedrooms, bathrooms, and optional distance from the map center.',
              },
              {
                id: 'props-roi-legend',
                selector: '.roi-legend',
                title: 'ROI color legend',
                body: 'Each property is tagged with a micro-flip ROI band so you can visually spot high, medium, low, or thin deals.',
              },
              {
                id: 'props-map',
                selector: '#propertiesMap',
                title: 'Map view with micro-flip callouts',
                body: 'Use the map to see where deals cluster geographically. Click pins to jump into detail and micro-flip analysis.',
              },
              {
                id: 'props-grid',
                selector: '#propertiesGrid',
                title: 'Property cards',
                body: 'Each card shows price, basics, and a preview ROI badge. Click a card to open full details and run a certified micro-flip.',
              },
            ],
          });

          try {
            var params = new URLSearchParams(window.location.search || '');
            if (params.get('guide') === 'client-properties') {
              window.AssiduousGuide.start('client-properties');
            }
          } catch (e) {}
        }
        var authInstance = (window.Firebase && window.Firebase.auth) || window.firebaseAuth;
        if (!authInstance || typeof authInstance.onAuthStateChanged !== 'function') {
          console.warn('[Client Properties] Auth not ready; rendering anonymous view');
          state.allProperties = [];
          state.filtered = [];
          renderResults();
          wireEvents();
          return;
        }

        // Dynamic import to keep bundle light and reuse admin logic
        import('../assets/js/services/propertyservice.js')
          .then(function (module) {
            propertyService = new module.PropertyService();
            wireEvents();
            authInstance.onAuthStateChanged(function (user) {
              if (!user) {
                state.allProperties = [];
                state.filtered = [];
                renderResults();
                return;
              }
              loadPropertiesForUser();
            });
          })
          .catch(function (err) {
            console.error('[Client Properties] Failed to load PropertyService:', err);
            wireEvents();
            state.allProperties = [];
            state.filtered = [];
            renderResults();
          });
      });
    })();
  </script>
</body>
</html>
