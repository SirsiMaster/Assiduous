<!DOCTYPE html>
<html lang="en" data-auth-protect="client,investor">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Offers - Assiduous Client Portal</title>
    
    <!-- Assiduous Design System -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fontsource/geist-sans@5.0.6/latin.css" rel="stylesheet">
    
    <link rel="stylesheet" href="../assiduous.css">
    <link rel="stylesheet" href="../components/admin-layout.css">
    
    <!-- Canonical modular Firebase auth: used by AuthService and auth-guard -->
    <script type="module">
        import Firebase, { AuthService } from '../assets/js/firebase-init.js';
        window.Firebase = Firebase;
        window.AuthService = AuthService;
    </script>
    
    <style>
/* Page-specific styles using design system variables */
        .content-grid {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: var(--space-xl);
            margin-bottom: var(--space-xl);
        }
        
        .viewings-section {
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: var(--space-lg);
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-lg);
            padding-bottom: var(--space-md);
            border-bottom: 1px solid var(--border);
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--navy);
        }
        
        .tabs {
            display: flex;
            gap: var(--space-sm);
            margin-bottom: var(--space-lg);
        }
        
        .tab {
            padding: var(--space-sm) var(--space-md);
            background: var(--gray-50);
            border: none;
            border-radius: var(--radius);
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .tab:hover {
            background: var(--gray-100);
        }
        
        .tab.active {
            background: var(--sky);
            color: var(--white);
        }
        
        .viewing-card {
            background: var(--gray-50);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            margin-bottom: var(--space-md);
            border-left: 4px solid var(--sky);
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .viewing-card:hover {
            transform: translateX(4px);
            box-shadow: var(--shadow-md);
        }
        
        .viewing-card.cancelled {
            opacity: 0.6;
            border-left-color: var(--danger);
        }
        
        .viewing-card.completed {
            border-left-color: var(--success);
        }
        
        .viewing-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-md);
        }
        
        .viewing-date {
            font-size: 16px;
            font-weight: 600;
            color: var(--navy);
        }
        
        .viewing-time {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 4px;
        }
        
        .viewing-status {
            padding: 4px 12px;
            border-radius: var(--radius);
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-pending {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }
        
        .status-confirmed {
            background: rgba(5, 150, 105, 0.1);
            color: var(--success);
        }
        
        .status-cancelled {
            background: rgba(220, 38, 38, 0.1);
            color: var(--danger);
        }
        
        .property-info {
            background: var(--white);
            border-radius: var(--radius);
            padding: var(--space-md);
            margin-bottom: var(--space-md);
        }
        
        .property-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--navy);
            margin-bottom: 4px;
        }
        
        .property-address {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .viewing-notes {
            font-size: 14px;
            color: var(--text-secondary);
            background: var(--white);
            padding: var(--space-sm);
            border-radius: var(--radius);
            margin-top: var(--space-sm);
        }
        
        .action-buttons {
            display: flex;
            gap: var(--space-sm);
            margin-top: var(--space-md);
        }
        
        .btn {
            padding: var(--space-xs) var(--space-md);
            border: none;
            border-radius: var(--radius);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn:hover {
            transform: translateY(-1px);
        }
        
        .btn-primary {
            background: var(--sky);
            color: var(--white);
        }
        
        .btn-primary:hover {
            background: var(--sky-dark);
        }
        
        .btn-secondary {
            background: var(--white);
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover {
            background: var(--gray-50);
        }
        
        .btn-danger {
            background: var(--danger);
            color: var(--white);
        }
        
        .btn-danger:hover {
            background: #b91c1c;
        }
        
        
        
        .calendar-widget, .quick-stats {
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: var(--space-lg);
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-md);
        }
        
        .month-year {
            font-size: 16px;
            font-weight: 600;
            color: var(--navy);
        }
        
        .calendar-nav {
            display: flex;
            gap: var(--space-sm);
        }
        
        .nav-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--gray-50);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .nav-btn:hover {
            background: var(--gray-100);
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }
        
        .day-header {
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            padding: var(--space-sm) 0;
        }
        
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius);
            font-size: 14px;
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
        }
        
        .calendar-day:hover {
            background: var(--gray-50);
        }
        
        .calendar-day.other-month {
            color: var(--text-tertiary);
        }
        
        .calendar-day.today {
            background: rgba(96, 163, 217, 0.1);
            color: var(--sky);
            font-weight: 600;
        }
        
        .calendar-day.has-viewing {
            background: var(--sky);
            color: var(--white);
        }
        
        .viewing-dot {
            position: absolute;
            bottom: 4px;
            width: 6px;
            height: 6px;
            background: var(--danger);
            border-radius: 50%;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-md);
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--navy);
            margin-bottom: 4px;
        }
        
        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .empty-state {
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: var(--space-3xl);
            text-align: center;
        }
        
        .empty-icon {
            font-size: 64px;
            margin-bottom: var(--space-lg);
        }
        
        .empty-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--navy);
            margin-bottom: var(--space-sm);
        }
        
        .empty-text {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: var(--space-xl);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--white);
            border-radius: var(--radius-md);
            padding: var(--space-xl);
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        @media (max-width: 768px) {
            .content-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="admin-wrapper" data-active="offers">
    <!-- UCS Sidebar Component -->
    <aside class="sidebar" data-component="sidebar"></aside>

    <!-- Main Content Area -->
    <div class="main-content">
        <!-- UCS Header Component -->
        <header data-component="header"></header>

        <!-- Dashboard Content -->
        <div class="dashboard-content">
<div class="content-grid">
                    <div class="viewings-section">
                        <div class="tabs">
                            <button class="tab active" onclick="filterOffers('open')">Open</button>
                            <button class="tab" onclick="filterOffers('won')">Won</button>
                            <button class="tab" onclick="filterOffers('lost')">Lost</button>
                            <button class="tab" onclick="filterOffers('all')">All</button>
                        </div>
                        
                        <div id="offersList">
                            <!-- Offers will be loaded here -->
                        </div>
                        
                        <div id="emptyState" class="empty-state" style="display: none;">
                            <div class="empty-icon">ðŸ“„</div>
                            <h2 class="empty-title">No Offers Yet</h2>
                            <p class="empty-text">Submit an offer on a property to see it tracked here.</p>
                            <button class="btn btn-primary" onclick="window.location.href='/client/properties.html'">
                                Browse Properties
                            </button>
                        </div>
                    </div>
                    
                    <div class="sidebar">
                        <div class="calendar-widget">
                            <div class="calendar-header">
                                <div class="month-year" id="currentMonth">December 2025</div>
                                <div class="calendar-nav">
                                    <button class="nav-btn" onclick="previousMonth()">â€¹</button>
                                    <button class="nav-btn" onclick="nextMonth()">â€º</button>
                                </div>
                            </div>
                            <div class="calendar-grid" id="calendar">
                                <!-- Calendar will be generated here -->
                            </div>
                        </div>
                        
                        <div class="quick-stats">
                            <h3 class="section-title">Offer Stats</h3>
                            <div class="stats-grid">
                                <div class="stat-item">
                                    <div class="stat-value" id="totalOffers">0</div>
                                    <div class="stat-label">Total Offers</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value" id="openCount">0</div>
                                    <div class="stat-label">Open</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value" id="wonCount">0</div>
                                    <div class="stat-label">Won</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value" id="lostCount">0</div>
                                    <div class="stat-label">Lost</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
        </div>
    </div>

    <!-- UCS Core Scripts (match client dashboard/messages) -->
    <script src="../components/ucs-core.js"></script>
    <script src="../components/component-registry.js"></script>
    <script src="../components/auth-guard.js"></script>
    <script>
        window.addEventListener('firebase-ready', function() {
            const firebase = window.Firebase || {};
            const db = firebase.db || window.firebaseDb;
            const auth = firebase.auth || window.firebaseAuth;

        
        let allOffers = [];
        let currentFilter = 'open';
        let currentMonthDate = new Date();
        
        function getOfferAmount(offer) {
            if (typeof offer.offerPrice === 'number') return offer.offerPrice;
            if (offer.details && typeof offer.details.offerAmount === 'number') return offer.details.offerAmount;
            return 0;
        }
        
        function getOfferStatus(offer) {
            return (offer.status || 'pending').toLowerCase();
        }
        
        function getOfferCreatedDate(offer) {
            if (offer.createdAt && typeof offer.createdAt.toDate === 'function') {
                return offer.createdAt.toDate();
            }
            if (offer.createdAt) {
                return new Date(offer.createdAt);
            }
            if (offer.timeline && offer.timeline.created) {
                return new Date(offer.timeline.created);
            }
            return new Date();
        }
        
        // Load offers from transactions
        async function loadOffers() {
            try {
                // Try to load from Firebase
                if (auth.currentUser) {
                    const snapshot = await db.collection('transactions')
                        .where('buyerId', '==', auth.currentUser.uid)
                        .orderBy('createdAt', 'desc')
                        .limit(100)
                        .get();
                    
                    allOffers = snapshot.docs.map(doc => {
                        const data = doc.data();
                        const createdDate = getOfferCreatedDate(data);
                        return {
                            id: doc.id,
                            ...data,
                            createdAt: createdDate,
                            uiDate: createdDate.toISOString().split('T')[0]
                        };
                    });
                }
            } catch (error) {
                console.log('Error loading offers from Firestore, falling back to local/demo:', error);
            }
            
            // Also check localStorage
            const localOffers = JSON.parse(localStorage.getItem('offers') || '[]');
            
            // Merge and deduplicate
            const mergedOffers = [...allOffers, ...localOffers];
            allOffers = Array.from(new Map(mergedOffers.map(o => [o.id || o.createdAt, o])).values());
            
            // Add demo offers if none exist
            if (allOffers.length === 0) {
                allOffers = getDemoOffers();
            }
            
            filterOffers(currentFilter);
            updateStats();
            generateCalendar();
        }
        
        // Get demo offers
        function getDemoOffers() {
            const today = new Date();
            const threeDaysAgo = new Date(today);
            threeDaysAgo.setDate(today.getDate() - 3);
            const tenDaysAgo = new Date(today);
            tenDaysAgo.setDate(today.getDate() - 10);
            
            return [
                {
                    id: 'demo-offer-1',
                    propertyTitle: '3BR Townhouse in Fishtown',
                    propertyAddress: '2547 Frankford Avenue, Philadelphia, PA',
                    offerPrice: 285000,
                    status: 'pending',
                    createdAt: threeDaysAgo,
                    uiDate: threeDaysAgo.toISOString().split('T')[0],
                    details: {
                        terms: {
                            closingDate: new Date(today.getFullYear(), today.getMonth() + 1, today.getDate()).toISOString().split('T')[0],
                            contingencies: ['financing', 'inspection']
                        }
                    }
                },
                {
                    id: 'demo-offer-2',
                    propertyTitle: '2BR Condo in Center City',
                    propertyAddress: '1500 Market Street, Philadelphia, PA',
                    offerPrice: 475000,
                    status: 'completed',
                    createdAt: tenDaysAgo,
                    uiDate: tenDaysAgo.toISOString().split('T')[0],
                    agreedPrice: 470000,
                    details: {
                        terms: {
                            closingDate: tenDaysAgo.toISOString().split('T')[0],
                            contingencies: ['inspection']
                        }
                    }
                }
            ];
        }
        
        // Filter offers
        function filterOffers(filter) {
            currentFilter = filter;
            let filtered = [];
            
            switch(filter) {
                case 'open':
                    filtered = allOffers.filter(o => {
                        const status = getOfferStatus(o);
                        return !['completed','closed','cancelled','rejected','lost'].includes(status);
                    });
                    break;
                case 'won':
                    filtered = allOffers.filter(o => {
                        const status = getOfferStatus(o);
                        return ['completed','closed','accepted'].includes(status);
                    });
                    break;
                case 'lost':
                    filtered = allOffers.filter(o => {
                        const status = getOfferStatus(o);
                        return ['cancelled','rejected','lost'].includes(status);
                    });
                    break;
                default:
                    filtered = allOffers;
            }
            
            // Update tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.textContent.toLowerCase().includes(filter)) {
                    tab.classList.add('active');
                }
            });
            
            displayOffers(filtered);
        }
        
        // Display offers
        function displayOffers(offers) {
            const container = document.getElementById('offersList');
            const emptyState = document.getElementById('emptyState');
            
            if (!offers || offers.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            container.innerHTML = offers.map(offer => {
                const createdDate = getOfferCreatedDate(offer);
                const amount = getOfferAmount(offer);
                const status = getOfferStatus(offer);
                const statusClass = status === 'cancelled' || status === 'rejected' || status === 'lost'
                    ? 'cancelled'
                    : (status === 'completed' || status === 'closed' || status === 'accepted' ? 'completed' : '');
                
                const closingDate = offer.details?.terms?.closingDate;
                const contingencies = offer.details?.terms?.contingencies || [];
                
                return `
                    <div class="viewing-card ${statusClass}">
                        <div class="viewing-header">
                            <div>
                                <div class="viewing-date">${createdDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</div>
                                <div class="viewing-time">Offer on ${offer.propertyTitle || 'Selected Property'}</div>
                            </div>
                            <div class="viewing-status status-${status}">
                                ${status.charAt(0).toUpperCase() + status.slice(1)}
                            </div>
                        </div>
                        
                        <div class="property-info">
                            <div class="property-title">${offer.propertyAddress || offer.propertyTitle || offer.propertyId || 'Property'}</div>
                            <div class="property-address">Offer Amount: $${amount.toLocaleString()}</div>
                        </div>
                        
                        <div class="viewing-notes">
                            ${closingDate ? `
                                <div><strong>Target Closing:</strong> ${closingDate}</div>
                            ` : ''}
                            ${contingencies.length ? `
                                <div><strong>Contingencies:</strong> ${contingencies.join(', ')}</div>
                            ` : ''}
                            ${offer.agreedPrice ? `
                                <div><strong>Agreed Price:</strong> $${Number(offer.agreedPrice).toLocaleString()}</div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Update statistics
        function updateStats() {
            const open = allOffers.filter(o => {
                const status = getOfferStatus(o);
                return !['completed','closed','cancelled','rejected','lost'].includes(status);
            });
            const won = allOffers.filter(o => {
                const status = getOfferStatus(o);
                return ['completed','closed','accepted'].includes(status);
            });
            const lost = allOffers.filter(o => {
                const status = getOfferStatus(o);
                return ['cancelled','rejected','lost'].includes(status);
            });
            
            const totalEl = document.getElementById('totalOffers');
            const openEl = document.getElementById('openCount');
            const wonEl = document.getElementById('wonCount');
            const lostEl = document.getElementById('lostCount');
            
            if (totalEl) totalEl.textContent = allOffers.length;
            if (openEl) openEl.textContent = open.length;
            if (wonEl) wonEl.textContent = won.length;
            if (lostEl) lostEl.textContent = lost.length;
        }
        
        // Generate calendar
        function generateCalendar() {
            const year = currentMonthDate.getFullYear();
            const month = currentMonthDate.getMonth();
            
            // Update month/year display
            document.getElementById('currentMonth').textContent = 
                currentMonthDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const prevLastDay = new Date(year, month, 0);
            
            const firstDayIndex = firstDay.getDay();
            const lastDayDate = lastDay.getDate();
            const prevLastDayDate = prevLastDay.getDate();
            
            const calendar = document.getElementById('calendar');
            calendar.innerHTML = '';
            
            // Day headers
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                const header = document.createElement('div');
                header.className = 'day-header';
                header.textContent = day;
                calendar.appendChild(header);
            });
            
            // Previous month days
            for (let i = firstDayIndex; i > 0; i--) {
                const day = document.createElement('div');
                day.className = 'calendar-day other-month';
                day.textContent = prevLastDayDate - i + 1;
                calendar.appendChild(day);
            }
            
            // Current month days
            const today = new Date();
            for (let i = 1; i <= lastDayDate; i++) {
                const day = document.createElement('div');
                day.className = 'calendar-day';
                day.textContent = i;
                
                const currentDate = new Date(year, month, i);
                const dateString = currentDate.toISOString().split('T')[0];
                
                // Check if today
                if (currentDate.toDateString() === today.toDateString()) {
                    day.classList.add('today');
                }
                
                // Check for offers on this day (by createdAt/uiDate)
                const hasOffer = allOffers.some(o => 
                    (o.uiDate || (o.createdAt && getOfferCreatedDate(o).toISOString().split('T')[0])) === dateString
                );
                if (hasOffer) {
                    day.classList.add('has-viewing');
                    const dot = document.createElement('div');
                    dot.className = 'viewing-dot';
                    day.appendChild(dot);
                }
                
                calendar.appendChild(day);
            }
            
            // Next month days
            const remainingDays = 42 - (firstDayIndex + lastDayDate);
            for (let i = 1; i <= remainingDays; i++) {
                const day = document.createElement('div');
                day.className = 'calendar-day other-month';
                day.textContent = i;
                calendar.appendChild(day);
            }
        }
        
        // Calendar navigation
        function previousMonth() {
            currentMonthDate.setMonth(currentMonthDate.getMonth() - 1);
            generateCalendar();
        }
        
        function nextMonth() {
            currentMonthDate.setMonth(currentMonthDate.getMonth() + 1);
            generateCalendar();
        }
        
        // Close modal on outside click
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        };
        
        // Check auth state
        auth.onAuthStateChanged((user) => {
            if (user) {
                console.log('User logged in:', user.email);
            }
            loadOffers();
        });
        
        // Load on page load (for demo/unauthenticated)
        window.addEventListener('load', () => {
            if (!auth.currentUser) {
                loadOffers();
            }
        });
        });
    </script>
</body>
</html>
