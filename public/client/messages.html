<!DOCTYPE html>
<html lang="en" data-auth-protect="client,investor">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages - Assiduous Client Portal</title>

    <!-- Assiduous Design System -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="../assiduous.css">
    <link rel="stylesheet" href="../components/admin-layout.css">

    <!-- Canonical modular Firebase bootstrap for portal pages -->
    <script type="module" src="../assets/js/firebase-init.js"></script>

    <style>
        /* Chat-specific styles using design system (mirrors agent/client layouts) */
        .messages-container {
            display: grid;
            grid-template-columns: 320px 1fr;
            height: calc(100vh - 120px);
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            overflow: hidden;
        }
        .conversations-sidebar {
            background: var(--white);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }
        .sidebar-header {
            padding: var(--space-lg);
            border-bottom: 1px solid var(--border);
        }
        .header-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--navy);
            margin-bottom: var(--space-sm);
        }
        .search-box {
            position: relative;
        }
        .search-box input {
            width: 100%;
            padding: var(--space-sm) var(--space-md) var(--space-sm) 40px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 14px;
        }
        .search-box input:focus {
            outline: none;
            border-color: var(--sky);
        }
        .search-icon {
            position: absolute;
            left: var(--space-md);
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }
        .conversations-list {
            flex: 1;
            overflow-y: auto;
        }
        .conversation-item {
            padding: var(--space-md) var(--space-lg);
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }
        .conversation-item:hover {
            background: var(--gray-50);
        }
        .conversation-item.active {
            background: rgba(96, 163, 217, 0.1);
            border-left: 3px solid var(--sky);
            padding-left: calc(var(--space-lg) - 3px);
        }
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--gradient);
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 16px;
            flex-shrink: 0;
        }
        .conversation-details {
            flex: 1;
            min-width: 0;
        }
        .conversation-name {
            font-weight: 600;
            color: var(--navy);
            margin-bottom: 4px;
        }
        .conversation-preview {
            font-size: 14px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .conversation-meta {
            text-align: right;
            flex-shrink: 0;
        }
        .conversation-time {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }
        .unread-badge {
            background: var(--sky);
            color: var(--white);
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 10px;
            display: inline-block;
        }
        .chat-area {
            display: flex;
            flex-direction: column;
        }
        .chat-header {
            padding: var(--space-lg);
            border-bottom: 1px solid var(--border);
            background: var(--white);
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }
        .chat-header-details {
            flex: 1;
        }
        .chat-header-name {
            font-size: 18px;
            font-weight: 600;
            color: var(--navy);
        }
        .chat-header-status {
            font-size: 14px;
            color: var(--success);
        }
        .messages-area {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-lg);
            background: var(--gray-50);
        }
        @media (max-width: 768px) {
            .messages-container {
                grid-template-columns: 1fr;
            }
            .conversations-sidebar {
                display: none;
            }
            .conversations-sidebar.show {
                display: flex;
                position: absolute;
                width: 100%;
                height: 100%;
                z-index: 10;
            }
        }
    </style>
</head>
<body class="admin-wrapper" data-active="messages">
    <!-- UCS Sidebar Component -->
    <aside class="sidebar" data-component="sidebar"></aside>

    <!-- Main Content Area -->
    <div class="main-content">
        <!-- UCS Header Component -->
        <header data-component="header"></header>

        <!-- Dashboard Content -->
        <div class="dashboard-content">
            <h1 class="page-title">Messages</h1>
            <p class="page-subtitle">All notifications and email mirrors sent to your account</p>

            <div id="inbox-root" class="messages-container" data-show-for-role="client,investor"></div>
        </div>
    </div>

    <!-- UCS Core Scripts -->
    <script src="../components/ucs-core.js"></script>
    <script src="../components/component-registry.js"></script>
    <script src="../components/auth-guard.js"></script>
    <script src="../components/universal-header.js"></script>
    <script src="../components/sidebar.js"></script>

    <!-- Persona-aware header text for Client/Investor Messages -->
    <script>
        (function() {
            function applyClientHeaderCopy() {
                var titleEl = document.querySelector('[data-header-title]');
                var subtitleEl = document.querySelector('[data-header-subtitle]');
                if (!titleEl || !subtitleEl) {
                    if (document.readyState === 'complete') {
                        setTimeout(applyClientHeaderCopy, 100);
                    } else {
                        window.addEventListener('load', function() {
                            setTimeout(applyClientHeaderCopy, 50);
                        }, { once: true });
                    }
                    return;
                }
                titleEl.textContent = 'Client Messages';
                subtitleEl.textContent = 'All notifications and email mirrors sent to your account';
            }
            setTimeout(applyClientHeaderCopy, 50);
        })();
    </script>

    <!-- Canonical client inbox viewer: users/{uid}/messages -->
    <script>
      (function() {
        function formatTime(ts) {
          if (!ts || !ts.toDate) return '';
          var d = ts.toDate();
          return d.toLocaleDateString(undefined, { month: 'short', day: 'numeric' }) + ' ' +
                 d.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
        }

        var latestDocs = [];

        function renderMessages(snapshot) {
          var container = document.getElementById('inbox-root');
          if (!container) return;
          var docs = snapshot && snapshot.docs ? snapshot.docs : [];
          latestDocs = docs;

          if (!docs.length) {
            container.innerHTML = '<div class="empty-state" style="padding:24px;">No messages yet. When you share properties or receive important notifications, they will appear here.</div>';
            return;
          }

          var items = docs.map(function(doc) {
            var data = doc.data();
            var subject = data.subject || '(No subject)';
            var preview = data.bodyPreview || '';
            var createdAt = formatTime(data.createdAt);
            return '\
              <div class="conversation-item" data-message-id="' + doc.id + '\">\
                <div class="avatar">IN</div>\
                <div class="conversation-details">\
                  <div class="conversation-name">' + subject + '</div>\
                  <div class="conversation-preview">' + preview + '</div>\
                </div>\
                <div class="conversation-meta">\
                  <div class="conversation-time">' + createdAt + '</div>\
                </div>\
              </div>';
          }).join('');

          container.innerHTML = '\
            <div class="conversations-sidebar">\
              <div class="sidebar-header">\
                <div class="header-title">Inbox</div>\
                <div class="search-box">\
                  <span class="search-icon">üîç</span>\
                  <input type="text" placeholder="Search messages (coming soon)" disabled />\
                </div>\
              </div>\
              <div class="conversations-list">' + items + '</div>\
            </div>\
            <div class="chat-area">\
              <div class="chat-header">\
                <div class="chat-header-details">\
                  <div class="chat-header-name">Portal Messages</div>\
                  <div class="chat-header-status">These entries mirror important emails and notifications.</div>\
                </div>\
              </div>\
              <div class="messages-area" id="messageDetailArea">\
                <p class="page-subtitle">Select a message on the left to view more detail.</p>\
              </div>\
            </div>';

          Array.prototype.forEach.call(container.querySelectorAll('.conversation-item'), function(item) {
            item.addEventListener('click', function() {
              var id = this.getAttribute('data-message-id');
              var doc = latestDocs.find(function(d) { return d.id === id; });
              if (!doc) return;
              var data = doc.data();
              var detail = document.getElementById('messageDetailArea');
              if (!detail) return;

              var createdAt = formatTime(data.createdAt);
              var meta = data.meta || {};

              detail.innerHTML = '\
                <div class="activity-card">\
                  <div class="activity-header">\
                    <h3 class="activity-title">' + (data.subject || '(No subject)') + '</h3>\
                    <span class="activity-status status-completed">' + createdAt + '</span>\
                  </div>\
                  <div class="activity-details">\
                    <div class="detail-item">\
                      <span class="detail-label">Preview</span>\
                      <span class="detail-value">' + (data.bodyPreview || '') + '</span>\
                    </div>\
                    <div class="detail-item">\
                      <span class="detail-label">Channel</span>\
                      <span class="detail-value">' + ((data.channels || []).join(', ') || 'inbox') + '</span>\
                    </div>\
                    <div class="detail-item">\
                      <span class="detail-label">External Provider</span>\
                      <span class="detail-value">' + (data.externalProvider || '‚Äî') + '</span>\
                    </div>\
                    <div class="detail-item">\
                      <span class="detail-label">Destination</span>\
                      <span class="detail-value">' + (data.email || '‚Äî') + '</span>\
                    </div>\
                  </div>\
                  <div class="info-box">\
                    <strong>Metadata</strong>\
                    <pre style="margin-top:8px;font-size:12px;background:#f9fafb;padding:8px;border-radius:6px;white-space:pre-wrap;">' +
                      JSON.stringify(meta, null, 2) + '</pre>\
                  </div>\
                </div>';
            });
          });
        }

        window.addEventListener('firebase-ready', function() {
          var firebase = window.Firebase || {};
          var auth = firebase.auth || window.firebaseAuth;
          var messagesService = firebase.DatabaseService || (typeof firebase.DatabaseService !== 'undefined' ? firebase.DatabaseService : null);

          if (!auth || !messagesService || typeof messagesService.onUserMessagesChange !== 'function') {
            console.error('[Client Messages] Firebase or DatabaseService not ready for inbox view');
            renderMessages({ docs: [] });
            return;
          }

          var unsubscribe = null;

          auth.onAuthStateChanged(function(user) {
            if (unsubscribe) {
              unsubscribe();
              unsubscribe = null;
            }

            if (!user) {
              renderMessages({ docs: [] });
              return;
            }

            unsubscribe = messagesService.onUserMessagesChange(
              user.uid,
              function(snapshot) {
                renderMessages(snapshot);
              },
              { limitCount: 50 }
            );
          });
        });
      })();
    </script>
</body>
</html>
