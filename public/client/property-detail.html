<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Property Detail - Assiduous Client Portal</title>
    
    <!-- Assiduous Design System -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/SirsiMaster/ui-components@latest/dist/sirsimaster-ui.css">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fontsource/geist-sans@5.0.6/latin.css" rel="stylesheet">
    
    <link rel="stylesheet" href="../assiduous.css">
    <link rel="stylesheet" href="../components/admin-layout.css">
    
    <style>
        /* Page-specific styles */
    </style>
</head>
<body class="admin-wrapper" data-active="property-detail">
    <!-- UCS Sidebar Component -->
    <aside class="sidebar" data-component="sidebar"></aside>

    <!-- Main Content Area -->
    <div class="main-content">
        <!-- UCS Header Component -->
        <header data-component="header"></header>

        <!-- Dashboard Content -->
        <div class="dashboard-content">
<!-- Content preserved from original -->

    
    
    <div class="container">
        </div>
        
        <div class="main-content">
            <div class="left-column">
                <div class="image-gallery">
                    <img id="mainImage" class="main-image" src="https://via.placeholder.com/800x400" alt="Property">
                    <div class="image-thumbnails" id="thumbnails"></div>
                </div>
                
                <div class="property-details">
                    <h2 class="section-title">Property Details</h2>
                    <div class="details-grid" id="detailsGrid">
                        <!-- Populated by JavaScript -->
                    </div>
                    
                    <h2 class="section-title">Description</h2>
                    <p class="description" id="description">Loading description...</p>
                    
                    <h2 class="section-title">Features & Amenities</h2>
                    <div class="features-list" id="featuresList">
                        <!-- Populated by JavaScript -->
                    </div>
                    
                    <div class="micro-flip-analysis">
                        <h2 class="section-title" style="color: white; border-color: rgba(255,255,255,0.3);">
                            Micro-Flip Investment Analysis
                        </h2>
                        <div class="analysis-grid">
                            <div class="analysis-item">
                                <div class="analysis-label">After Repair Value</div>
                                <div class="analysis-value" id="arvValue">$0</div>
                            </div>
                            <div class="analysis-item">
                                <div class="analysis-label">Est. Repair Cost</div>
                                <div class="analysis-value" id="repairCost">$0</div>
                            </div>
                            <div class="analysis-item">
                                <div class="analysis-label">Potential Profit</div>
                                <div class="analysis-value" id="potentialProfit">$0</div>
                            </div>
                            <div class="analysis-item">
                                <div class="analysis-label">Market Demand</div>
                                <div class="analysis-value" id="marketDemand">-</div>
                            </div>
                        </div>
                        
                        <h3 style="color: white; margin: 20px 0 10px;">Recommended Repairs</h3>
                        <div class="repair-list" id="repairList">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="sidebar">
                <div class="action-card">
                    <button class="btn btn-save" id="saveBtn" onclick="toggleSave()">
                        <span id="saveText">❤️ Save Property</span>
                    </button>
                    <button class="btn btn-primary" onclick="showContactModal()">
                        Contact Agent
                    </button>
                    <button class="btn btn-secondary" onclick="showViewingModal()">
                        Schedule Viewing
                    </button>
                    <button class="btn btn-secondary" onclick="window.location.href='/client/micro-flip-calculator.html'">
                        Calculate ROI
                    </button>
                </div>
                
                <div class="action-card">
                    <h3 class="section-title">Listing Agent</h3>
                    <div class="agent-card">
                        <div class="agent-avatar" id="agentAvatar">JD</div>
                        <div class="agent-info">
                            <div class="agent-name" id="agentName">Loading...</div>
                            <div class="agent-rating" id="agentRating">⭐⭐⭐⭐⭐ 5.0</div>
                        </div>
                    </div>
                    <button class="btn btn-secondary" onclick="showContactModal()">
                        Message Agent
                    </button>
                </div>
                
                <div class="action-card">
                    <h3 class="section-title">Property Stats</h3>
                    <div class="details-grid">
                        <div>
                            <div class="detail-label">Views</div>
                            <div class="detail-value" id="viewCount">0</div>
                        </div>
                        <div>
                            <div class="detail-label">Saved</div>
                            <div class="detail-value" id="saveCount">0</div>
                        </div>
                        <div>
                            <div class="detail-label">Days on Market</div>
                            <div class="detail-value" id="daysOnMarket">0</div>
                        </div>
                        <div>
                            <div class="detail-label">Price/Sqft</div>
                            <div class="detail-value" id="pricePerSqft">$0</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Contact Modal -->
    <div class="modal" id="contactModal">
        <div class="modal-content">
            <h2 class="modal-title">Contact Agent</h2>
            <form id="contactForm">
                <div class="form-group">
                    <label class="form-label">Your Name</label>
                    <input type="text" class="form-input" id="contactName" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="contactEmail" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Phone</label>
                    <input type="tel" class="form-input" id="contactPhone">
                </div>
                <div class="form-group">
                    <label class="form-label">Message</label>
                    <textarea class="form-textarea" id="contactMessage" required>I'm interested in this property. Please contact me with more information.</textarea>
                </div>
                <button type="submit" class="btn btn-primary">Send Message</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal('contactModal')">Cancel</button>
            </form>
        </div>
    </div>
    
    <!-- Viewing Modal -->
    <div class="modal" id="viewingModal">
        <div class="modal-content">
            <h2 class="modal-title">Schedule Viewing</h2>
            <form id="viewingForm">
                <div class="form-group">
                    <label class="form-label">Preferred Date</label>
                    <input type="date" class="form-input" id="viewingDate" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Preferred Time</label>
                    <select class="form-input" id="viewingTime" required>
                        <option value="">Select time</option>
                        <option value="9:00 AM">9:00 AM</option>
                        <option value="10:00 AM">10:00 AM</option>
                        <option value="11:00 AM">11:00 AM</option>
                        <option value="12:00 PM">12:00 PM</option>
                        <option value="1:00 PM">1:00 PM</option>
                        <option value="2:00 PM">2:00 PM</option>
                        <option value="3:00 PM">3:00 PM</option>
                        <option value="4:00 PM">4:00 PM</option>
                        <option value="5:00 PM">5:00 PM</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Your Name</label>
                    <input type="text" class="form-input" id="viewingName" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Phone</label>
                    <input type="tel" class="form-input" id="viewingPhone" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Additional Notes</label>
                    <textarea class="form-textarea" id="viewingNotes"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Schedule Viewing</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal('viewingModal')">Cancel</button>
            </form>
        </div>
    </div>
        </div>
    </div>

    <!-- UCS Core Scripts -->
    <script src="../components/ucs-core.js"></script>
    <script src="../components/component-registry.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="{{BASE_PATH}}firebase-config.js"></script>
    <script>
        window.addEventListener('firebase-ready', function() {
            const headerScript = document.createElement('script');
            headerScript.src = '../components/universal-header.js';
            document.head.appendChild(headerScript);
            
            headerScript.onload = function() {
                // Load sidebar first
                const sidebarScript = document.createElement('script');
                sidebarScript.src = '../components/sidebar.js';
                document.head.appendChild(sidebarScript);
                
                // Then auth guard
                sidebarScript.onload = function() {
                    const authScript = document.createElement('script');
                    authScript.src = '../components/auth-guard-simple.js';
                    document.head.appendChild(authScript);
                };
            };
        });
    </script>
    <script>
        window.addEventListener('firebase-ready', function() {
            const db = window.db;
            const auth = window.auth;

        
        // Get property ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const propertyId = urlParams.get('id');
        let currentProperty = null;
        let savedProperties = JSON.parse(localStorage.getItem('savedProperties') || '[]');
        
        // Load property details
        async function loadProperty() {
            if (!propertyId) {
                // Load mock data for demo
                loadMockProperty();
                return;
            }
            
            try {
                const doc = await db.collection('properties').doc(propertyId).get();
                if (doc.exists) {
                    currentProperty = { id: doc.id, ...doc.data() };
                    displayProperty(currentProperty);
                    
                    // Increment view count
                    await db.collection('properties').doc(propertyId).update({
                        views: firebase.firestore.FieldValue.increment(1)
                    });
                } else {
                    loadMockProperty();
                }
            } catch (error) {
                console.error('Error loading property:', error);
                loadMockProperty();
            }
        }
        
        // Load mock property for demo
        function loadMockProperty() {
            currentProperty = {
                id: 'demo-property',
                title: '3BR Townhouse in Fishtown - Perfect Flip',
                address: '2547 Frankford Avenue',
                city: 'Philadelphia',
                state: 'PA',
                zipCode: '19125',
                neighborhood: 'Fishtown',
                price: 285000,
                bedrooms: 3,
                bathrooms: 2,
                sqft: 1450,
                type: 'townhouse',
                yearBuilt: 1925,
                description: 'Investor\'s dream in hot Fishtown market! This 3 bedroom townhouse offers tremendous upside potential with cosmetic updates. Original hardwood floors, high ceilings, and great bones. Walking distance to trendy restaurants and nightlife. Perfect for micro-flipping with estimated 25% ROI.',
                features: ['Hardwood Floors', 'High Ceilings', 'Original Details', 'Private Backyard', 'Near Transit'],
                images: [
                    'https://source.unsplash.com/800x600/?townhouse,exterior',
                    'https://source.unsplash.com/800x600/?livingroom',
                    'https://source.unsplash.com/800x600/?kitchen',
                    'https://source.unsplash.com/800x600/?bedroom',
                    'https://source.unsplash.com/800x600/?bathroom'
                ],
                microFlipping: {
                    afterRepairValue: 385000,
                    estimatedRepairCost: 35000,
                    potentialProfit: 65000,
                    roi: 25,
                    investmentScore: 87,
                    repairItems: [
                        { item: 'Kitchen Update', cost: 12000 },
                        { item: 'Bathroom Renovation', cost: 8000 },
                        { item: 'Paint & Flooring', cost: 7000 },
                        { item: 'Landscaping', cost: 3000 },
                        { item: 'Fixtures & Hardware', cost: 5000 }
                    ],
                    marketDemand: 'High'
                },
                views: 234,
                saves: 18,
                listingDate: new Date(Date.now() - 15 * 24 * 60 * 60 * 1000).toISOString(),
                agentId: 'agent_1',
                agentName: 'John Davis',
                parking: 'Street',
                heating: 'Gas',
                cooling: 'Central Air',
                basement: 'Full',
                taxAmount: 4275
            };
            
            displayProperty(currentProperty);
        }
        
        // Display property details
        function displayProperty(property) {
            document.getElementById('propertyTitle').textContent = property.title;
            document.getElementById('propertyAddress').textContent = 
                `${property.address}, ${property.city}, ${property.state} ${property.zipCode}`;
            document.getElementById('propertyPrice').textContent = `$${property.price.toLocaleString()}`;
            
            if (property.microFlipping) {
                document.getElementById('propertyROI').textContent = `${property.microFlipping.roi}% ROI`;
                document.getElementById('investmentScore').textContent = 
                    `Score: ${property.microFlipping.investmentScore}/100`;
                
                // Micro-flip analysis
                document.getElementById('arvValue').textContent = 
                    `$${property.microFlipping.afterRepairValue.toLocaleString()}`;
                document.getElementById('repairCost').textContent = 
                    `$${property.microFlipping.estimatedRepairCost.toLocaleString()}`;
                document.getElementById('potentialProfit').textContent = 
                    `$${property.microFlipping.potentialProfit.toLocaleString()}`;
                document.getElementById('marketDemand').textContent = property.microFlipping.marketDemand;
                
                // Repair items
                const repairList = document.getElementById('repairList');
                repairList.innerHTML = property.microFlipping.repairItems.map(item => `
                    <div class="repair-item">
                        <span>${item.item}</span>
                        <span>$${item.cost.toLocaleString()}</span>
                    </div>
                `).join('');
            }
            
            // Images
            if (property.images && property.images.length > 0) {
                document.getElementById('mainImage').src = property.images[0];
                const thumbnails = document.getElementById('thumbnails');
                thumbnails.innerHTML = property.images.map((img, index) => `
                    <img class="thumbnail ${index === 0 ? 'active' : ''}" 
                         src="${img}" 
                         onclick="changeMainImage('${img}', this)">
                `).join('');
            }
            
            // Details grid
            const detailsGrid = document.getElementById('detailsGrid');
            detailsGrid.innerHTML = `
                <div class="detail-item">
                    <div>
                        <div class="detail-label">Bedrooms</div>
                        <div class="detail-value">${property.bedrooms}</div>
                    </div>
                </div>
                <div class="detail-item">
                    <div>
                        <div class="detail-label">Bathrooms</div>
                        <div class="detail-value">${property.bathrooms}</div>
                    </div>
                </div>
                <div class="detail-item">
                    <div>
                        <div class="detail-label">Square Feet</div>
                        <div class="detail-value">${property.sqft.toLocaleString()}</div>
                    </div>
                </div>
                <div class="detail-item">
                    <div>
                        <div class="detail-label">Year Built</div>
                        <div class="detail-value">${property.yearBuilt}</div>
                    </div>
                </div>
                <div class="detail-item">
                    <div>
                        <div class="detail-label">Property Type</div>
                        <div class="detail-value">${property.type.replace('_', ' ')}</div>
                    </div>
                </div>
                <div class="detail-item">
                    <div>
                        <div class="detail-label">Neighborhood</div>
                        <div class="detail-value">${property.neighborhood}</div>
                    </div>
                </div>
                <div class="detail-item">
                    <div>
                        <div class="detail-label">Parking</div>
                        <div class="detail-value">${property.parking || 'Street'}</div>
                    </div>
                </div>
                <div class="detail-item">
                    <div>
                        <div class="detail-label">Annual Tax</div>
                        <div class="detail-value">$${(property.taxAmount || 0).toLocaleString()}</div>
                    </div>
                </div>
            `;
            
            // Description
            document.getElementById('description').textContent = property.description;
            
            // Features
            const featuresList = document.getElementById('featuresList');
            featuresList.innerHTML = property.features.map(feature => 
                `<span class="feature-tag">${feature}</span>`
            ).join('');
            
            // Stats
            document.getElementById('viewCount').textContent = property.views || 0;
            document.getElementById('saveCount').textContent = property.saves || 0;
            
            const listingDate = new Date(property.listingDate);
            const daysOnMarket = Math.floor((Date.now() - listingDate) / (1000 * 60 * 60 * 24));
            document.getElementById('daysOnMarket').textContent = daysOnMarket;
            
            const pricePerSqft = Math.round(property.price / property.sqft);
            document.getElementById('pricePerSqft').textContent = `$${pricePerSqft}`;
            
            // Agent info
            document.getElementById('agentName').textContent = property.agentName || 'Sarah Johnson';
            document.getElementById('agentAvatar').textContent = 
                (property.agentName || 'Sarah Johnson').split(' ').map(n => n[0]).join('');
            
            // Check if saved
            updateSaveButton();
        }
        
        // Change main image
        function changeMainImage(src, thumbnail) {
            document.getElementById('mainImage').src = src;
            document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active'));
            thumbnail.classList.add('active');
        }
        
        // Toggle save property using new favorites service
        async function toggleSave() {
            if (!currentProperty) return;
            
            try {
                // Import favorites service dynamically
                const { toggleFavorite, initializeFavoritesService } = await import('../assets/js/services/favoritesservice.js');
                const { default: Firebase } = await import('../assets/js/firebase-init.js');
                
                // Initialize if not already done
                const firebaseConfig = {
                    apiKey: 'AIzaSyCnQajchoBwP_VMEvc9mKH-vO0xlZjGCRE',
                    authDomain: 'assiduous-prod.firebaseapp.com',
                    projectId: 'assiduous-prod',
                    storageBucket: 'assiduous-prod.firebasestorage.app',
                    messagingSenderId: '9355377564',
                    appId: '1:9355377564:web:84bd6fa0e7c8a2e7c3f56b',
                };
                
                initializeFavoritesService(firebaseConfig);
                
                // Toggle in Firestore
                const isFavorited = await toggleFavorite(currentProperty.id);
                
                // Update local state for backward compatibility
                const index = savedProperties.findIndex(p => p.id === currentProperty.id);
                if (isFavorited && index === -1) {
                    savedProperties.push({
                        id: currentProperty.id,
                        title: currentProperty.title,
                        price: currentProperty.price,
                        address: currentProperty.address,
                        image: currentProperty.images ? currentProperty.images[0] : '',
                        savedAt: new Date().toISOString()
                    });
                } else if (!isFavorited && index > -1) {
                    savedProperties.splice(index, 1);
                }
                
                localStorage.setItem('savedProperties', JSON.stringify(savedProperties));
                updateSaveButton();
                
                console.log(`Property ${isFavorited ? 'saved' : 'removed'}`);
            } catch (error) {
                console.error('Error toggling favorite:', error);
                
                // Fallback to local storage only
                const index = savedProperties.findIndex(p => p.id === currentProperty.id);
                if (index > -1) {
                    savedProperties.splice(index, 1);
                } else {
                    savedProperties.push({
                        id: currentProperty.id,
                        title: currentProperty.title,
                        price: currentProperty.price,
                        address: currentProperty.address,
                        image: currentProperty.images ? currentProperty.images[0] : '',
                        savedAt: new Date().toISOString()
                    });
                }
                localStorage.setItem('savedProperties', JSON.stringify(savedProperties));
                updateSaveButton();
                
                alert('Please sign in to save properties to your account.');
            }
        }
        
        // Update save button state
        function updateSaveButton() {
            const saveBtn = document.getElementById('saveBtn');
            const saveText = document.getElementById('saveText');
            const isSaved = savedProperties.some(p => p.id === currentProperty.id);
            
            if (isSaved) {
                saveBtn.classList.add('saved');
                saveText.textContent = '❤️ Saved';
            } else {
                saveBtn.classList.remove('saved');
                saveText.textContent = '❤️ Save Property';
            }
        }
        
        // Modal functions
        function showContactModal() {
            document.getElementById('contactModal').classList.add('active');
        }
        
        function showViewingModal() {
            document.getElementById('viewingModal').classList.add('active');
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }
        
        // Handle contact form submission using new lead service
        document.getElementById('contactForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const leadData = {
                propertyId: currentProperty.id,
                name: document.getElementById('contactName').value,
                email: document.getElementById('contactEmail').value,
                phone: document.getElementById('contactPhone').value,
                message: document.getElementById('contactMessage').value
            };
            
            try {
                // Import lead service dynamically
                const { submitLead } = await import('../assets/js/services/leadservice.js');
                const result = await submitLead(leadData);
                
                if (result && result.id) {
                    alert('Message sent successfully! An agent will contact you soon.');
                    closeModal('contactModal');
                    document.getElementById('contactForm').reset();
                } else {
                    throw new Error('Failed to submit lead');
                }
            } catch (error) {
                console.error('Error sending message:', error);
                alert('Error sending message. Please try again or call us directly.');
            }
        });
        
        // Handle viewing form submission  
        document.getElementById('viewingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const viewing = {
                propertyId: currentProperty.id,
                propertyTitle: currentProperty.title,
                date: document.getElementById('viewingDate').value,
                time: document.getElementById('viewingTime').value,
                name: document.getElementById('viewingName').value,
                phone: document.getElementById('viewingPhone').value,
                notes: document.getElementById('viewingNotes').value,
                type: 'viewing',
                status: 'pending',
                createdAt: new Date().toISOString()
            };
            
            try {
                await db.collection('viewings').add(viewing);
                alert('Viewing scheduled successfully! You will receive a confirmation call.');
                closeModal('viewingModal');
                document.getElementById('viewingForm').reset();
            } catch (error) {
                console.error('Error scheduling viewing:', error);
                
                // Save locally as fallback
                const localViewings = JSON.parse(localStorage.getItem('viewings') || '[]');
                localViewings.push(viewing);
                localStorage.setItem('viewings', JSON.stringify(localViewings));
                alert('Viewing request saved! Check your dashboard for updates.');
                closeModal('viewingModal');
            }
        });
        
        // Close modal on outside click
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        };
        
        // Load property on page load
        window.addEventListener('load', loadProperty);
        });
    </script>
</body>
</html>
