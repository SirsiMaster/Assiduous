<!DOCTYPE html>
<html lang="en" data-auth-protect="admin">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>My QR Code - Admin - Assiduous</title>

    <link rel="stylesheet" href="../assiduous.css">
    <link rel="stylesheet" href="../components/admin-layout.css">

    <script type="module">
        import Firebase, { AuthService } from '../assets/js/firebase-init.js';
        window.Firebase = Firebase;
        window.AuthService = AuthService;
    </script>
</head>
<body class="admin-wrapper" data-active="admin-my-qr">
    <aside class="sidebar" data-component="sidebar"></aside>
    <div class="main-content">
        <header data-component="header"></header>
        <div class="dashboard-content">
            <h1>My Profile QR Code</h1>
            <p>Share your admin profile/settings page with a scannable QR code.</p>
            <div id="qrDisplay" class="qr-display-section">
                <div class="qr-loading">Loading your QR code...</div>
            </div>
            <p>Profile link: <span id="profileUrl" class="profile-url"></span></p>
            <div class="qr-actions-grid">
                <button onclick="downloadQR()">Download QR</button>
                <button onclick="copyProfileLink()">Copy link</button>
                <button onclick="shareQR()">Share</button>
                <button onclick="regenerateQR()">Regenerate</button>
            </div>
        </div>
    </div>

    <script src="../components/ucs-core.js"></script>
    <script src="../components/component-registry.js"></script>
    <script src="../components/auth-guard.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script>
        let currentUser = null;
        let currentQRData = null;
        let auth;

        function buildProfileUrl(user) {
            const origin = window.location.origin || 'https://assiduous-prod.web.app';
            return `${origin}/admin/profile.html?id=${encodeURIComponent(user.uid)}`;
        }

        function renderQRDisplay() {
            if (!currentQRData || !currentQRData.profileUrl) return;
            const qrDisplay = document.getElementById('qrDisplay');
            const profileUrl = currentQRData.profileUrl;

            document.getElementById('profileUrl').textContent = profileUrl;
            qrDisplay.innerHTML = '';
            const canvasContainer = document.createElement('div');
            canvasContainer.id = 'qrCanvas';
            qrDisplay.appendChild(canvasContainer);

            if (window.QRCode) {
                new QRCode(canvasContainer, {
                    text: profileUrl,
                    width: 300,
                    height: 300,
                    correctLevel: QRCode.CorrectLevel.H,
                });
            } else {
                canvasContainer.innerHTML = `<a href="${profileUrl}">${profileUrl}</a>`;
            }
        }

        function generateQrForCurrentUser(forceNew) {
            if (!currentUser) return;
            const profileUrl = buildProfileUrl(currentUser);
            const cacheBuster = forceNew ? `&t=${Date.now()}` : '';
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(profileUrl)}${cacheBuster}`;
            currentQRData = { profileUrl, qrCodeUrl: qrUrl };
            renderQRDisplay();
        }

        window.addEventListener('firebase-ready', () => {
            const firebase = window.Firebase || {};
            auth = firebase.auth || window.firebaseAuth;
            auth.onAuthStateChanged((user) => {
                if (!user) {
                    window.location.href = '../index.html#login';
                    return;
                }
                currentUser = user;
                generateQrForCurrentUser(false);
            });
        });

        function downloadQR() {
            if (!currentQRData || !currentUser) return;
            const container = document.getElementById('qrCanvas');
            if (!container) return;
            const canvas = container.querySelector('canvas');
            const img = container.querySelector('img');
            let dataUrl = null;
            try {
                if (canvas && canvas.toDataURL) {
                    dataUrl = canvas.toDataURL('image/png');
                } else if (img && img.src) {
                    dataUrl = img.src;
                }
            } catch (e) {
                console.warn('downloadQR(admin): failed to extract data URL', e);
            }
            if (!dataUrl) return;
            const link = document.createElement('a');
            link.href = dataUrl;
            link.download = `${currentUser.displayName || 'My'}-Profile-QR.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function copyProfileLink() {
            if (!currentQRData) return;
            navigator.clipboard.writeText(currentQRData.profileUrl).catch(() => {});
        }

        function shareQR() {
            if (!currentQRData) return;
            if (navigator.share) {
                navigator.share({
                    title: 'My Assiduous Admin Profile',
                    text: 'Connect with me on Assiduous',
                    url: currentQRData.profileUrl
                }).catch(() => {});
            } else {
                copyProfileLink();
            }
        }

        function regenerateQR() {
            generateQrForCurrentUser(true);
        }
    </script>
</body>
</html>