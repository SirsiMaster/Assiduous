<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages - Assiduous</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            height: 100vh;
            overflow: hidden;
        }
        
        .container {
            display: grid;
            grid-template-columns: 320px 1fr;
            height: 100vh;
            background: white;
        }
        
        .sidebar {
            background: white;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
        }
        
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .header-title {
            font-size: 24px;
            font-weight: 700;
            color: #333;
            margin-bottom: 10px;
        }
        
        .search-box {
            position: relative;
        }
        
        .search-box input {
            width: 100%;
            padding: 10px 40px 10px 15px;
            border: 1px solid #e0e0e0;
            border-radius: 25px;
            font-size: 14px;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }
        
        .conversations-list {
            flex: 1;
            overflow-y: auto;
        }
        
        .conversation-item {
            padding: 15px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .conversation-item:hover {
            background: #f8f9fa;
        }
        
        .conversation-item.active {
            background: #f0f7ff;
            border-left: 3px solid #667eea;
            padding-left: 17px;
        }
        
        .avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 18px;
            flex-shrink: 0;
        }
        
        .conversation-details {
            flex: 1;
            min-width: 0;
        }
        
        .conversation-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }
        
        .conversation-role {
            font-size: 12px;
            color: #667eea;
            margin-bottom: 4px;
        }
        
        .conversation-preview {
            font-size: 14px;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .conversation-meta {
            text-align: right;
            flex-shrink: 0;
        }
        
        .conversation-time {
            font-size: 12px;
            color: #999;
            margin-bottom: 4px;
        }
        
        .unread-badge {
            background: #667eea;
            color: white;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 10px;
            display: inline-block;
        }
        
        .chat-area {
            display: flex;
            flex-direction: column;
        }
        
        .chat-header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            background: white;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .chat-header-details {
            flex: 1;
        }
        
        .chat-header-name {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }
        
        .chat-header-status {
            font-size: 14px;
            color: #28a745;
        }
        
        .chat-header-actions {
            display: flex;
            gap: 10px;
        }
        
        .action-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: #f8f9fa;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .action-btn:hover {
            background: #e9ecef;
        }
        
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }
        
        .message {
            display: flex;
            margin-bottom: 15px;
            align-items: flex-end;
            gap: 10px;
        }
        
        .message.sent {
            flex-direction: row-reverse;
        }
        
        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #e0e0e0;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
        }
        
        .message.sent .message-avatar {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .message-content {
            max-width: 70%;
        }
        
        .message-bubble {
            background: white;
            padding: 12px 16px;
            border-radius: 18px;
            border: 1px solid #e0e0e0;
            word-wrap: break-word;
        }
        
        .message.sent .message-bubble {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
        }
        
        .message-time {
            font-size: 12px;
            color: #999;
            margin-top: 4px;
            text-align: right;
        }
        
        .message.sent .message-time {
            text-align: left;
        }
        
        .property-card-message {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #e0e0e0;
            margin-top: 8px;
        }
        
        .property-card-image {
            height: 120px;
            background: linear-gradient(135deg, #667eea, #764ba2);
        }
        
        .property-card-details {
            padding: 12px;
        }
        
        .property-card-title {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .property-card-address {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }
        
        .property-card-price {
            font-size: 18px;
            font-weight: 700;
            color: #28a745;
        }
        
        .message-input-area {
            padding: 20px;
            border-top: 1px solid #e0e0e0;
            background: white;
        }
        
        .message-input-container {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        
        .message-input-wrapper {
            flex: 1;
            position: relative;
        }
        
        .message-input {
            width: 100%;
            padding: 12px 50px 12px 15px;
            border: 1px solid #e0e0e0;
            border-radius: 25px;
            font-size: 14px;
            resize: none;
            max-height: 120px;
        }
        
        .message-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .attachment-btn {
            position: absolute;
            right: 15px;
            bottom: 12px;
            background: none;
            border: none;
            cursor: pointer;
            color: #999;
            font-size: 20px;
        }
        
        .send-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .send-btn:hover {
            transform: scale(1.05);
        }
        
        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #999;
        }
        
        .empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
        
        .empty-title {
            font-size: 24px;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }
        
        .empty-text {
            font-size: 16px;
            color: #666;
        }
        
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
            background: white;
            border-radius: 18px;
            border: 1px solid #e0e0e0;
            width: fit-content;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            background: #999;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }
        
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }
        
        .date-divider {
            text-align: center;
            margin: 20px 0;
            position: relative;
        }
        
        .date-divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #e0e0e0;
        }
        
        .date-divider-text {
            background: #f8f9fa;
            padding: 0 15px;
            position: relative;
            color: #999;
            font-size: 12px;
            font-weight: 600;
        }
        
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                display: none;
                position: fixed;
                width: 100%;
                height: 100%;
                z-index: 100;
            }
            
            .sidebar.mobile-visible {
                display: flex;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h1 class="header-title">Messages</h1>
                <div class="search-box">
                    <input type="text" placeholder="Search conversations..." id="searchInput">
                    <span class="search-icon">🔍</span>
                </div>
            </div>
            
            <div class="conversations-list" id="conversationsList">
                <!-- Conversations will be loaded here -->
            </div>
        </div>
        
        <div class="chat-area">
            <div id="emptyChat" class="empty-state">
                <div class="empty-icon">💬</div>
                <h2 class="empty-title">Select a conversation</h2>
                <p class="empty-text">Choose a conversation from the list to start messaging</p>
            </div>
            
            <div id="chatContent" style="display: none; flex: 1; flex-direction: column;">
                <div class="chat-header">
                    <button class="action-btn" onclick="toggleSidebar()" style="display: none;" id="mobileBackBtn">
                        ←
                    </button>
                    <div class="avatar" id="chatAvatar">JD</div>
                    <div class="chat-header-details">
                        <div class="chat-header-name" id="chatName">John Doe</div>
                        <div class="chat-header-status" id="chatStatus">Active now</div>
                    </div>
                    <div class="chat-header-actions">
                        <button class="action-btn" onclick="makeCall()">📞</button>
                        <button class="action-btn" onclick="scheduleViewing()">📅</button>
                        <button class="action-btn" onclick="showPropertyDetails()">🏠</button>
                    </div>
                </div>
                
                <div class="messages-container" id="messagesContainer">
                    <!-- Messages will be loaded here -->
                </div>
                
                <div id="typingIndicator" style="display: none; padding: 0 20px;">
                    <div class="message">
                        <div class="message-avatar">JD</div>
                        <div class="typing-indicator">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                </div>
                
                <div class="message-input-area">
                    <form id="messageForm" onsubmit="sendMessage(event)">
                        <div class="message-input-container">
                            <div class="message-input-wrapper">
                                <textarea 
                                    class="message-input" 
                                    id="messageInput" 
                                    placeholder="Type a message..." 
                                    rows="1"
                                    onkeypress="handleKeyPress(event)"
                                    oninput="autoResize(this)"
                                ></textarea>
                                <button type="button" class="attachment-btn" onclick="attachFile()">📎</button>
                            </div>
                            <button type="submit" class="send-btn" id="sendBtn">
                                ➤
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCzPcEJ0TPKnJtcVT2qymgJrII1p0vAJxs",
            authDomain: "assiduous-prod.firebaseapp.com",
            projectId: "assiduous-prod",
            storageBucket: "assiduous-prod.appspot.com",
            messagingSenderId: "594472642287",
            appId: "1:594472642287:web:adf723a456b123c4567890"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        let currentConversationId = null;
        let currentUserId = null;
        let messagesListener = null;
        let conversations = [];
        
        // Demo data
        const demoConversations = [
            {
                id: 'conv-1',
                agentId: 'agent-1',
                agentName: 'Sarah Johnson',
                agentRole: 'Real Estate Agent',
                lastMessage: 'Great! I can schedule a viewing for tomorrow',
                lastMessageTime: new Date(Date.now() - 1000 * 60 * 30).toISOString(),
                unread: 2
            },
            {
                id: 'conv-2',
                agentId: 'agent-2',
                agentName: 'Mike Chen',
                agentRole: 'Investment Specialist',
                lastMessage: 'The micro-flip analysis looks promising',
                lastMessageTime: new Date(Date.now() - 1000 * 60 * 60 * 2).toISOString(),
                unread: 0
            },
            {
                id: 'conv-3',
                agentId: 'agent-3',
                agentName: 'Emily Rodriguez',
                agentRole: 'Buyer\'s Agent',
                lastMessage: 'I found 3 properties that match your criteria',
                lastMessageTime: new Date(Date.now() - 1000 * 60 * 60 * 24).toISOString(),
                unread: 5
            }
        ];
        
        const demoMessages = {
            'conv-1': [
                {
                    id: 'msg-1',
                    text: 'Hi Sarah! I\'m interested in the property at 2547 Frankford Ave',
                    sender: 'user',
                    timestamp: new Date(Date.now() - 1000 * 60 * 60).toISOString()
                },
                {
                    id: 'msg-2',
                    text: 'Hello! That\'s a great choice. It\'s a beautiful 3BR townhouse in Fishtown.',
                    sender: 'agent',
                    timestamp: new Date(Date.now() - 1000 * 60 * 55).toISOString()
                },
                {
                    id: 'msg-3',
                    text: 'Can we schedule a viewing?',
                    sender: 'user',
                    timestamp: new Date(Date.now() - 1000 * 60 * 45).toISOString()
                },
                {
                    id: 'msg-4',
                    text: 'Great! I can schedule a viewing for tomorrow',
                    sender: 'agent',
                    timestamp: new Date(Date.now() - 1000 * 60 * 30).toISOString()
                }
            ]
        };
        
        // Load conversations
        async function loadConversations() {
            const container = document.getElementById('conversationsList');
            
            // Try to load from Firebase
            if (auth.currentUser) {
                try {
                    const snapshot = await db.collection('conversations')
                        .where('participants', 'array-contains', auth.currentUser.uid)
                        .orderBy('lastMessageTime', 'desc')
                        .get();
                    
                    conversations = [];
                    snapshot.forEach(doc => {
                        conversations.push({ id: doc.id, ...doc.data() });
                    });
                } catch (error) {
                    console.log('Loading demo conversations:', error);
                }
            }
            
            // Use demo data if no conversations
            if (conversations.length === 0) {
                conversations = demoConversations;
            }
            
            displayConversations(conversations);
        }
        
        // Display conversations
        function displayConversations(convs) {
            const container = document.getElementById('conversationsList');
            
            if (convs.length === 0) {
                container.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #999;">
                        No conversations yet
                    </div>
                `;
                return;
            }
            
            container.innerHTML = convs.map(conv => {
                const initials = conv.agentName.split(' ').map(n => n[0]).join('');
                const time = formatTime(conv.lastMessageTime);
                
                return `
                    <div class="conversation-item ${conv.id === currentConversationId ? 'active' : ''}" 
                         onclick="selectConversation('${conv.id}')">
                        <div class="avatar">${initials}</div>
                        <div class="conversation-details">
                            <div class="conversation-name">${conv.agentName}</div>
                            <div class="conversation-role">${conv.agentRole}</div>
                            <div class="conversation-preview">${conv.lastMessage}</div>
                        </div>
                        <div class="conversation-meta">
                            <div class="conversation-time">${time}</div>
                            ${conv.unread > 0 ? `<span class="unread-badge">${conv.unread}</span>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Select conversation
        async function selectConversation(conversationId) {
            currentConversationId = conversationId;
            const conv = conversations.find(c => c.id === conversationId);
            
            if (!conv) return;
            
            // Update UI
            document.getElementById('emptyChat').style.display = 'none';
            document.getElementById('chatContent').style.display = 'flex';
            document.getElementById('chatContent').style.flex = '1';
            document.getElementById('chatContent').style.flexDirection = 'column';
            
            // Update header
            const initials = conv.agentName.split(' ').map(n => n[0]).join('');
            document.getElementById('chatAvatar').textContent = initials;
            document.getElementById('chatName').textContent = conv.agentName;
            
            // Update active state
            document.querySelectorAll('.conversation-item').forEach(item => {
                item.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            
            // Clear unread count
            conv.unread = 0;
            displayConversations(conversations);
            
            // Load messages
            loadMessages(conversationId);
            
            // Mobile view
            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('mobile-visible');
                document.getElementById('mobileBackBtn').style.display = 'block';
            }
        }
        
        // Load messages
        async function loadMessages(conversationId) {
            const container = document.getElementById('messagesContainer');
            let messages = [];
            
            // Try to load from Firebase
            if (auth.currentUser) {
                try {
                    // Set up real-time listener
                    if (messagesListener) {
                        messagesListener();
                    }
                    
                    messagesListener = db.collection('conversations')
                        .doc(conversationId)
                        .collection('messages')
                        .orderBy('timestamp', 'asc')
                        .onSnapshot(snapshot => {
                            messages = [];
                            snapshot.forEach(doc => {
                                messages.push({ id: doc.id, ...doc.data() });
                            });
                            displayMessages(messages);
                        });
                } catch (error) {
                    console.log('Loading demo messages:', error);
                }
            }
            
            // Use demo data
            if (messages.length === 0 && demoMessages[conversationId]) {
                messages = demoMessages[conversationId];
                displayMessages(messages);
            }
        }
        
        // Display messages
        function displayMessages(messages) {
            const container = document.getElementById('messagesContainer');
            let lastDate = null;
            
            container.innerHTML = messages.map(msg => {
                const messageDate = new Date(msg.timestamp).toDateString();
                let dateHeader = '';
                
                if (messageDate !== lastDate) {
                    lastDate = messageDate;
                    const today = new Date().toDateString();
                    const yesterday = new Date(Date.now() - 86400000).toDateString();
                    
                    let dateText = messageDate;
                    if (messageDate === today) dateText = 'Today';
                    else if (messageDate === yesterday) dateText = 'Yesterday';
                    
                    dateHeader = `
                        <div class="date-divider">
                            <span class="date-divider-text">${dateText}</span>
                        </div>
                    `;
                }
                
                const isSent = msg.sender === 'user' || msg.senderId === auth.currentUser?.uid;
                const time = new Date(msg.timestamp).toLocaleTimeString('en-US', { 
                    hour: 'numeric', 
                    minute: '2-digit' 
                });
                
                return `
                    ${dateHeader}
                    <div class="message ${isSent ? 'sent' : 'received'}">
                        ${!isSent ? '<div class="message-avatar">SA</div>' : ''}
                        <div class="message-content">
                            <div class="message-bubble">${msg.text}</div>
                            ${msg.propertyId ? `
                                <div class="property-card-message">
                                    <div class="property-card-image"></div>
                                    <div class="property-card-details">
                                        <div class="property-card-title">3BR Townhouse</div>
                                        <div class="property-card-address">2547 Frankford Ave</div>
                                        <div class="property-card-price">$450,000</div>
                                    </div>
                                </div>
                            ` : ''}
                            <div class="message-time">${time}</div>
                        </div>
                        ${isSent ? '<div class="message-avatar">You</div>' : ''}
                    </div>
                `;
            }).join('');
            
            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }
        
        // Send message
        async function sendMessage(event) {
            event.preventDefault();
            
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text || !currentConversationId) return;
            
            const message = {
                text,
                senderId: auth.currentUser?.uid || 'user',
                sender: 'user',
                timestamp: new Date().toISOString(),
                read: false
            };
            
            // Save to Firebase if logged in
            if (auth.currentUser) {
                try {
                    await db.collection('conversations')
                        .doc(currentConversationId)
                        .collection('messages')
                        .add(message);
                    
                    // Update conversation last message
                    await db.collection('conversations')
                        .doc(currentConversationId)
                        .update({
                            lastMessage: text,
                            lastMessageTime: new Date().toISOString()
                        });
                } catch (error) {
                    console.error('Error sending message:', error);
                }
            }
            
            // Add to local demo data
            if (!demoMessages[currentConversationId]) {
                demoMessages[currentConversationId] = [];
            }
            demoMessages[currentConversationId].push({
                id: `msg-${Date.now()}`,
                ...message
            });
            
            // Update conversation
            const conv = conversations.find(c => c.id === currentConversationId);
            if (conv) {
                conv.lastMessage = text;
                conv.lastMessageTime = new Date().toISOString();
                displayConversations(conversations);
            }
            
            displayMessages(demoMessages[currentConversationId]);
            
            // Clear input
            input.value = '';
            autoResize(input);
            
            // Simulate agent typing
            setTimeout(() => {
                document.getElementById('typingIndicator').style.display = 'block';
                document.getElementById('messagesContainer').scrollTop = 
                    document.getElementById('messagesContainer').scrollHeight;
            }, 1000);
            
            // Simulate agent response
            setTimeout(() => {
                document.getElementById('typingIndicator').style.display = 'none';
                
                const agentResponse = {
                    id: `msg-${Date.now()}`,
                    text: getAgentResponse(text),
                    sender: 'agent',
                    timestamp: new Date().toISOString()
                };
                
                demoMessages[currentConversationId].push(agentResponse);
                displayMessages(demoMessages[currentConversationId]);
                
                // Update conversation
                conv.lastMessage = agentResponse.text;
                conv.lastMessageTime = agentResponse.timestamp;
                displayConversations(conversations);
            }, 3000);
        }
        
        // Get simulated agent response
        function getAgentResponse(userMessage) {
            const responses = [
                "I'll look into that for you right away!",
                "That's a great question. Let me check our listings.",
                "I can definitely help you with that property.",
                "Would you like to schedule a viewing?",
                "I have some similar properties you might be interested in.",
                "The seller is very motivated. We might be able to negotiate.",
                "This property has excellent investment potential.",
                "I'll send you more details about the property."
            ];
            
            if (userMessage.toLowerCase().includes('viewing')) {
                return "I can schedule a viewing for tomorrow at 2 PM or Thursday at 10 AM. Which works better for you?";
            } else if (userMessage.toLowerCase().includes('price')) {
                return "The asking price is $450,000, but there's room for negotiation. The seller is motivated!";
            } else if (userMessage.toLowerCase().includes('hello') || userMessage.toLowerCase().includes('hi')) {
                return "Hello! How can I help you today?";
            }
            
            return responses[Math.floor(Math.random() * responses.length)];
        }
        
        // Format time
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays}d ago`;
            
            return date.toLocaleDateString();
        }
        
        // Auto-resize textarea
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }
        
        // Handle key press
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage(event);
            }
        }
        
        // Search conversations
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const search = e.target.value.toLowerCase();
            const filtered = conversations.filter(conv => 
                conv.agentName.toLowerCase().includes(search) ||
                conv.lastMessage.toLowerCase().includes(search)
            );
            displayConversations(filtered);
        });
        
        // Utility functions
        function makeCall() {
            alert('Calling agent... (This feature requires phone integration)');
        }
        
        function scheduleViewing() {
            window.location.href = '/client/viewings.html';
        }
        
        function showPropertyDetails() {
            window.location.href = '/client/property-detail.html';
        }
        
        function attachFile() {
            alert('File attachment coming soon!');
        }
        
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('mobile-visible');
        }
        
        // Check auth and load
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUserId = user.uid;
            }
            loadConversations();
        });
        
        // Handle window resize
        window.addEventListener('resize', () => {
            if (window.innerWidth > 768) {
                document.getElementById('sidebar').classList.remove('mobile-visible');
                document.getElementById('mobileBackBtn').style.display = 'none';
            }
        });
    </script>
</body>
</html>