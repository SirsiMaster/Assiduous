name: Deploy Metrics to Firebase

on:
  push:
    branches: [ main ]
    paths:
      - '**.js'
      - '**.html'
      - '**.json'
      - 'firebase-migration-package/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Get full git history for metrics
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install Firebase CLI
        run: npm install -g firebase-tools
      
      - name: Update metrics from git
        run: |
          cd ${{ github.workspace }}
          node scripts/update-metrics-enhanced.js
      
      - name: Display metrics summary
        run: |
          cat firebase-migration-package/assiduous-build/admin/development/metrics_cache.json | jq '{
            commits: .project.totalCommits,
            totalDays: .project.totalDays,
            activeDays: .project.activeDays,
            cost: .project.totalCost
          }'
      
      - name: Deploy to Firebase
        run: |
          cd firebase-migration-package/assiduous-build
          firebase deploy --only hosting --token ${{ secrets.FIREBASE_TOKEN }} --non-interactive
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
      
      - name: Verify deployment
        run: |
          echo "‚úÖ Deployment complete!"
          echo "üåê Dashboard: https://assiduous-prod.web.app/admin/development/dashboard.html"
          echo "üìä Metrics API: https://assiduous-prod.web.app/admin/development/metrics_cache.json"
